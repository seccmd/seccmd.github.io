import{_ as i}from"./plugin-vue_export-helper-DlAUqK2U.js";import{c as a,f as e,o as l}from"./app-D1IULfj1.js";const n={};function t(h,s){return l(),a("div",null,[...s[0]||(s[0]=[e(`<h1 id="headscale" tabindex="-1"><a class="header-anchor" href="#headscale"><span>Headscale</span></a></h1><p>Headscale 是一款开源自托管的 Tailscale</p><h2 id="一、网络主流工具选型对比" tabindex="-1"><a class="header-anchor" href="#一、网络主流工具选型对比"><span>一、网络主流工具选型对比</span></a></h2><blockquote><p>深入学习<a href="https://headscale.net/stable/ref/configuration/" target="_blank" rel="noopener noreferrer">https://headscale.net/stable/ref/configuration/</a></p></blockquote><blockquote><p>Usage <a href="https://headscale.net/stable/usage/getting-started/" target="_blank" rel="noopener noreferrer">https://headscale.net/stable/usage/getting-started/</a> 本身支持Remote CLI，默认无admin 管理界面，使用第三方的。</p></blockquote><blockquote><p>Headscale - Running headscale in a container <a href="https://headscale.net/stable/setup/install/container/" target="_blank" rel="noopener noreferrer">https://headscale.net/stable/setup/install/container/</a></p></blockquote><p>对比多种网络打通方案：<a href="https://mp.weixin.qq.com/s?__biz=MzI0NTU1MTA5MA==&amp;mid=2247487999&amp;idx=1&amp;sn=039bcccab192e995d7bd043f3f9c7802&amp;chksm=e873b0c5b672096d6cb4bf8bb36f6d1f36e5507ccf455d4a54fd77d62523e8b7eb4759fecaf7&amp;mpshare=1&amp;scene=1&amp;srcid=0715FpXD8A6SPB8ojte3TUQl&amp;sharer_shareinfo=b21aee4e622b53f4a17c0c8b45c78cc7&amp;sharer_shareinfo_first=b21aee4e622b53f4a17c0c8b45c78cc7#rd" target="_blank" rel="noopener noreferrer">链接地址</a></p><h3 id="主流工具横向对比" tabindex="-1"><a class="header-anchor" href="#主流工具横向对比"><span><strong>主流工具横向对比</strong></span></a></h3><p>废话不多说，直接上表格，让你一目了然。</p><table><thead><tr><th>特性</th><th>Easytier</th><th>ZeroTier / Tailscale</th><th>FRP / Natapp</th><th>Cloudflare Tunnel</th></tr></thead><tbody><tr><td><strong>核心原理</strong></td><td>P2P虚拟局域网</td><td>P2P虚拟局域网</td><td>端口转发</td><td>端口转发/虚拟网络</td></tr><tr><td><strong>配置复杂度</strong></td><td><strong>极低</strong></td><td>低</td><td><strong>高</strong></td><td>中等</td></tr><tr><td><strong>依赖公网IP</strong></td><td><strong>需要（但可共用）</strong></td><td>不需要</td><td><strong>需要</strong></td><td>不需要</td></tr><tr><td><strong>中心化依赖</strong></td><td><strong>完全去中心化</strong></td><td><strong>依赖官方控制器</strong></td><td>自建服务端，半中心化</td><td>依赖Cloudflare</td></tr><tr><td><strong>安全性/隐私</strong></td><td><strong>极高（流量端到端加密）</strong></td><td>高（依赖官方）</td><td>中等（取决于自己配置）</td><td>高（依赖Cloudflare）</td></tr><tr><td><strong>使用场景</strong></td><td>个人/小团队私有网络</td><td>个人/企业级便捷组网</td><td>将内网服务暴露到公网</td><td>将服务接入CF生态</td></tr><tr><td><strong>我的评价</strong></td><td>简单、私密、自由</td><td><strong>最方便</strong> ，但有束缚</td><td>功能强大，但<strong>太折腾</strong></td><td>免费用户的福音，但有绑定</td></tr></tbody></table><p><strong>一句话总结：</strong></p><ul><li>• <strong>FRP</strong>：适合需要将服务（如网站）明确暴露到公网的场景。</li><li>• <strong>ZeroTier/Tailscale</strong>：追求极致方便，不介意依赖第三方服务的个人和团队首选。</li><li>• <strong>Cloudflare Tunnel</strong>：如果你已经是Cloudflare用户，用它整合服务体验极佳。</li><li>• <strong>Easytier</strong>：<strong>想要ZeroTier的方便，又想要FRP的自主可控，那么Easytier就是为你量身定做的。</strong></li></ul><h2 id="二、拓扑图-tailscale" tabindex="-1"><a class="header-anchor" href="#二、拓扑图-tailscale"><span>二、拓扑图 Tailscale</span></a></h2><div class="language-markdown line-numbers-mode" data-highlighter="shiki" data-ext="markdown" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-markdown"><span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">                            +-----------------------+</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">                            |      Headscale        |</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">                            | (Control Server)      |</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">                            | - 用户认证/ACL管理    |</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">                            | - 节点协调            |</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">                            +-----------+-----------+</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">                                        | (HTTPS API)</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">                                        |</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">+------------------------+    +---------v---------+    +------------------------+</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">|      Node1-PC          |    |      DERP         |    |      Node3-VPS         |</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">| (Windows/Linux)        &lt;----+ (中继服务器)       +----&gt; (云服务器/公网IP)     |</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">| - 100.xx.xx.xx         |    | - TCP流量转发      |    | - 100.xx.xx.xx         |</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">| - 子网路由(可选)       |    | - 加密盲转发       |    | - 出口节点(Exit Node)  |</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">+------------------------+    +---------+---------+    +------------------------+</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">                                        |</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">                                        |</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">                            +-----------v---------+</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">                            |      Node2-Mac      |</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">                            | (macOS/iOS)        |</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">                            | - 100.xx.xx.xx     |</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">                            | - 移动端访问       |</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">                            +---------------------+</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="node-节点清单" tabindex="-1"><a class="header-anchor" href="#node-节点清单"><span>Node 节点清单</span></a></h3><p>Headscale 注册服务</p><ul><li><code>tailscale up --login-server https://headscale.home:8443</code> —hostname=xxx</li><li>DERP: <a href="https://rerp.home:8443" target="_blank" rel="noopener noreferrer">https://rerp.home:8443</a></li></ul><p>Tailscale status</p><ul><li>100.64.0.1 desktop u03 windows</li><li>100.64.0.4 hk-vps u03 linux</li><li>100.64.0.5 office-pc u03 windows</li><li>100.64.0.6 imac u01 macOS</li></ul><h2 id="三、客户端安装-tailscale" tabindex="-1"><a class="header-anchor" href="#三、客户端安装-tailscale"><span>三、客户端安装 tailscale</span></a></h2><div class="language-markdown line-numbers-mode" data-highlighter="shiki" data-ext="markdown" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-markdown"><span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">## Windows 安装 - 必须使用msi exe会报错</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">https://pkgs.tailscale.com/stable/tailscale-setup-1.86.0-amd64.msi</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">## Linux 安装</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">curl -fsSL https://tailscale.com/install.sh | sh</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">## Mac 安装 - 手动开启 tailscale 命令</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">## 注册服务</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">tailscale up --login-server https://headscale.home.xxx.com/</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">## 网络状态</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">tailscale status</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">tailscale netcheck</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"># 管理员权限</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">Stop-Service Tailscale</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">Start-Service Tailscale # 开启服务，并且必须打开 Tailscal图形界面，右下角小图标！</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"># 其他操作</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">tailscale logout</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">tailscale down</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="四、服务端操作-headscale" tabindex="-1"><a class="header-anchor" href="#四、服务端操作-headscale"><span>四、服务端操作 headscale</span></a></h2><div class="language-markdown line-numbers-mode" data-highlighter="shiki" data-ext="markdown" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-markdown"><span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">## 操作命令</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">headscale users list</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">headscale users create u01</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">docker exec -it headscale headscale users create u01</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">docker exec -it headscale headscale nodes register --user u01 --key &lt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">key</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">docker exec -it headscale headscale preauthkeys create --user 1 --reusable --expiration 24h</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">tailscale up --login-server &lt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">YOUR_HEADSCALE_URL</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt; --authkey &lt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">YOUR_AUTH_KEY</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">docker exec -it headscale headscale nodes list</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">docker exec -it headscale headscale nodes delete -i &lt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">ID</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt;</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"># Debug</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"># 检查服务状态</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">systemctl status tailscaled  # 应为 active (running)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"># 查看实时日志</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">journalctl -u tailscaled -f</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"># 测试节点连通性</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">tailscale ping &lt;另一节点IP&gt;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="五、headscale-demo-测试" tabindex="-1"><a class="header-anchor" href="#五、headscale-demo-测试"><span>五、Headscale Demo 测试</span></a></h2><ul><li>Using packages for Debian/Ubuntu (recommended)</li></ul><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># Install</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">https://headscale.net/stable/setup/install/official/</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># Download - https://github.com/juanfont/headscale/releases/latest</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">HEADSCALE_VERSION</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;0.26.1&quot;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"> # See above URL for latest version, e.g. &quot;X.Y.Z&quot; </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">HEADSCALE_ARCH</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;amd64&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">wget</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> --output-document=headscale.deb</span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;"> \\</span></span>
<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;https://github.com/juanfont/headscale/releases/download/v</span><span style="--shiki-light:#E45649;--shiki-dark:#98C379;">\${</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">HEADSCALE_VERSION</span><span style="--shiki-light:#E45649;--shiki-dark:#98C379;">}</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">/headscale_</span><span style="--shiki-light:#E45649;--shiki-dark:#98C379;">\${</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">HEADSCALE_VERSION</span><span style="--shiki-light:#E45649;--shiki-dark:#98C379;">}</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">_linux_</span><span style="--shiki-light:#E45649;--shiki-dark:#98C379;">\${</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">HEADSCALE_ARCH</span><span style="--shiki-light:#E45649;--shiki-dark:#98C379;">}</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">.deb&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">sudo</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> apt</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> install</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ./headscale.deb</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">sudo</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> nano</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> /etc/headscale/config.yaml</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">sudo</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> systemctl</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> enable</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> --now</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> headscale</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">sudo</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> systemctl</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> status</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> headscale</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 只测试配置以下选项 /etc/headscale/config.yaml</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">server_url:</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> http://47.76.253.98:8080</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">listen_addr:</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 0.0.0.0:8080</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-markdown line-numbers-mode" data-highlighter="shiki" data-ext="markdown" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-markdown"><span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"># Usage</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">https://headscale.net/stable/usage/getting-started/</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">headscale users list</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">headscale users create &lt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">USER</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"># 注册方式一 Normal, interactive login</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">client: tailscale up --login-server &lt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">YOUR_HEADSCALE_URL</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">server: headscale nodes register --user &lt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">USER</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt; --key &lt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">YOUR_MACHINE_KEY</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"># 注册方式二 Using a preauthkey</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">server: headscale preauthkeys create --user &lt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">USER</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">client: tailscale up --login-server http://47.76.253.98:8080 --authkey &lt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">YOUR_AUTH_KEY</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="六、问题" tabindex="-1"><a class="header-anchor" href="#六、问题"><span>六、问题</span></a></h2><p><strong>退出登录即断开连接​</strong>​：Tailscale 当用户主动退出登录（Log out）时，客户端会立即终止 VPN 连接</p><ul><li>Tailscale配置中，开启Run unattach 配置勾选</li><li>远程桌面断开后自动关闭：强制会话转移到控制台（本地会话） <ul><li><p>在远程桌面连接时，通过CMD执行以下命令：</p><p><code>query session# 获取当前会话ID（如ID=1）</code></p><p><code>tscon 1 /dest:console# 将会话1转移到本地控制台</code></p></li><li><p><strong>原理</strong>：<code>tscon</code> 命令将远程会话无缝转移到本地控制台会话，保持所有进程运行，即使断开远程连接也不会终止</p></li></ul></li></ul><p><strong>/etc/default/tailscaled 配置文件丢失</strong></p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">/etc/default/tailscaled</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 配置文件丢失</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">启动参数需要</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> --port=</span><span style="--shiki-light:#E45649;--shiki-dark:#D19A66;">\${</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">PORT</span><span style="--shiki-light:#E45649;--shiki-dark:#D19A66;">}</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> $FLAGS</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 默认值？</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">ExecStart</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">/usr/sbin/tailscaled</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> --state</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">/var/lib/tailscale/tailscaled.state</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> --socket</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">/run/tailscale/tailscaled.sock</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> --port</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">41641</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># /etc/default/tailscaled</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">PORT</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">41641</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  # 默认值可省略</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">FLAGS</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;--login-server=http://your-headscale-ip:8080&quot;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="七、headscale-技术方案介绍" tabindex="-1"><a class="header-anchor" href="#七、headscale-技术方案介绍"><span>七、Headscale 技术方案介绍</span></a></h2><p>Headscale 是一款开源自托管的 Tailscale 控制服务器实现，专为追求私有化部署、数据自主可控的用户设计。以下从核心价值、技术特性、部署方案、应用场景等维度系统解析其方案设计：</p><hr><h3 id="🔧-一、核心定位与私有化价值" tabindex="-1"><a class="header-anchor" href="#🔧-一、核心定位与私有化价值"><span>🔧 一、核心定位与私有化价值</span></a></h3><ol><li><p><strong>Tailscale 的替代控制面</strong></p><p>Headscale 完全复刻 Tailscale 控制面逻辑，兼容官方客户端，但将控制服务器从 SaaS 云端迁移至用户自有环境，实现：</p><ul><li><strong>数据主权</strong>：所有节点注册信息、ACL 策略、通信状态均存储于私有数据库（SQLite/PostgreSQL）；</li><li><strong>无设备限制</strong>：开源版本无设备数量或功能限制，企业可自由扩展；</li><li><strong>协议兼容性</strong>：基于 WireGuard 协议构建点对点加密隧道，保留高效穿透与低延迟特性。</li></ul></li><li><p><strong>解决 SaaS 痛点</strong></p><p>针对 Tailscale 官方服务的不足：</p><ul><li><strong>合规性</strong>：满足金融、政企等场景的本地化部署需求；</li><li><strong>网络优化</strong>：自建 DERP 中继节点，避免跨国流量绕行（如国内访问官方节点延迟高）；</li><li><strong>自定义扩展</strong>：支持与 LDAP/SSO 集成、自定义 ACL 策略等。</li></ul></li></ol><hr><h3 id="⚙️-二、功能特性与技术优势" tabindex="-1"><a class="header-anchor" href="#⚙️-二、功能特性与技术优势"><span>⚙️ 二、功能特性与技术优势</span></a></h3><table><thead><tr><th><strong>能力模块</strong></th><th><strong>关键特性</strong></th><th><strong>技术价值</strong></th></tr></thead><tbody><tr><td><strong>网络架构</strong></td><td>基于 NAT 穿透的网状拓扑（P2P 优先，中继备用）</td><td>减少中转带宽成本，直连延迟低至 10ms 级</td></tr><tr><td><strong>认证与权限</strong></td><td>支持预授权密钥、OIDC 单点登录、多命名空间隔离</td><td>灵活对接企业 IAM 系统，实现租户隔离</td></tr><tr><td><strong>策略控制</strong></td><td>精细化 ACL 策略（按 IP/端口/协议限制访问），MagicDNS 自动域名解析</td><td>替代传统防火墙规则，动态管控设备通信</td></tr><tr><td><strong>中继服务</strong></td><td>内置或自建 DERP 服务器，支持 UDP/TCP 中继</td><td>穿透严格 NAT 环境，提升连接成功率</td></tr><tr><td><strong>运维支持</strong></td><td>集成 Prometheus 监控、日志审计、API 驱动自动化</td><td>企业级可观测性与自动化运维</td></tr></tbody></table><hr><h3 id="🚀-三、部署方案与实践路径" tabindex="-1"><a class="header-anchor" href="#🚀-三、部署方案与实践路径"><span>🚀 三、部署方案与实践路径</span></a></h3><h4 id="_1-基础部署-二进制-systemd" tabindex="-1"><a class="header-anchor" href="#_1-基础部署-二进制-systemd"><span><strong>1. 基础部署（二进制/Systemd）</strong></span></a></h4><ul><li><strong>适用场景</strong>：单服务器快速部署</li><li><strong>步骤概要</strong>： <ol><li>下载二进制文件并配置：</li></ol></li></ul><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">wget</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> https://github.com/juanfont/headscale/releases/download/v0.26.1/headscale_0.26.1_linux_amd64</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -O</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> /usr/local/bin/headscale</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">chmod</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> +x</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> /usr/local/bin/headscale</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_2-创建配置文件-etc-headscale-config-yaml-关键配置" tabindex="-1"><a class="header-anchor" href="#_2-创建配置文件-etc-headscale-config-yaml-关键配置"><span>2. 创建配置文件 <code>/etc/headscale/config.yaml</code>，关键配置：</span></a></h4><div class="language-yaml line-numbers-mode" data-highlighter="shiki" data-ext="yaml" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-yaml"><span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">server_url</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">https://47.76.253.98</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  # 公网访问地址</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">listen_addr</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">0.0.0.0:8080</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">ip_prefixes</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: [</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">100.64.0.0/10</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">]  </span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 客户端分配 IP 段</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">derp</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">:</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">  server</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">:</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">    enabled</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">true</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">    region_id</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">999</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  # 自定义区域 ID（避免与公共 DERP 冲突）</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">    region_code</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;selfhosted&quot;</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">    region_name</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;Self-hosted DERP&quot;</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">    stun_listen_addr</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;0.0.0.0:3478&quot;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  # STUN 服务端口</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">    private_key_path</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">/etc/headscale/derp_private.key</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">noise</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">:</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">  private_key_path</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">/etc/headscale/noise_private.key</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  # 自动生成密钥文件</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">dns</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">:</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">  magic_dns</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">true</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  # 启用 MagicDNS</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">  base_domain</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;my.local&quot;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  # 替换为你的私有域名后缀</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">  override_local_dns</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">true</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">  nameservers</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">:</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">    global</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">:</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">      - </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;1.1.1.1&quot;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">      - </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;8.8.8.8&quot;</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 必须配置的 IP 地址池</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">prefixes</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">:</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">  v4</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">100.64.0.0/10</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">         # IPv4 地址段（必选）</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  # v6: fd7a:115c:a1e0::/48 # 可选 IPv6 段</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">allocation</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">sequential</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">      # IP 分配策略（sequential 或 random）</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">database</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">:</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">  type</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">sqlite</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  # 或 postgres</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">  sqlite</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">:</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">    path</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">/opt/jupyter-lab/headscale/db.sqlite</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  # SQLite 数据库文件路径</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_3-通过-systemd-托管服务。" tabindex="-1"><a class="header-anchor" href="#_3-通过-systemd-托管服务。"><span>3. 通过 Systemd 托管服务。</span></a></h4><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">headscale</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> users</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> list</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">headscale</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> users</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> create</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> u01</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">其他替代方案：使用预授权密钥​</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">为避免手动注册，可生成预授权密钥（适合自动化部署）：</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">headscale</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> preauthkeys</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> create</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -u</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 1</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">客户端直接通过密钥连接：此方式无需手动执行</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> nodes</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> register</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 命令</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">tailscale</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> up</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> --login-server=http://47.76.253.98:8080</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> --authkey</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 15f46f928e6d5b421c08608f42978253dab8dedc49c5bc8d</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_2-容器化部署-docker-k8s" tabindex="-1"><a class="header-anchor" href="#_2-容器化部署-docker-k8s"><span><strong>2. 容器化部署（Docker/K8s）</strong></span></a></h4><ul><li><strong>适用场景</strong>：需弹性扩缩容或集成云原生体系</li><li><strong>方案要点</strong>： <ul><li><strong>Docker Compose</strong>：配置端口映射与持久化卷；</li><li><strong>Kubernetes</strong>：通过 Ingress 暴露服务，结合 CSI 存储数据库；</li><li><strong>Sealos 一键部署</strong>：云原生应用模板，15 秒完成部署（含可视化控制台）。</li></ul></li></ul><h4 id="_3-客户端接入" tabindex="-1"><a class="header-anchor" href="#_3-客户端接入"><span><strong>3. 客户端接入</strong></span></a></h4><ul><li><strong>命令示例（Linux）</strong>：</li></ul><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">tailscale</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> up</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> --login-server=http://</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">HEADSCALE_IP</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt;</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">:8080</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> --accept-dns=false</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><pre><code>访问返回的 URL 完成注册，或在 Headscale 执行：
</code></pre><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">headscale</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> nodes</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> register</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> --user</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> &lt;</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">命名空</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">间&gt; </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">--key</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> &lt;</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">设备密</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">钥&gt;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><ul><li><strong>跨平台支持</strong>：Windows/macOS 客户端需修改配置指向自建服务器；Android/iOS 需侧载修改版客户端。</li></ul><p>Headscale 客户端的接入方法因操作系统而异，以下是主要平台的详细步骤和注意事项：</p><hr><h3 id="_1-linux-客户端接入" tabindex="-1"><a class="header-anchor" href="#_1-linux-客户端接入"><span><strong>1. Linux 客户端接入</strong></span></a></h3><h4 id="步骤" tabindex="-1"><a class="header-anchor" href="#步骤"><span><strong>步骤</strong>：</span></a></h4><ol><li><strong>安装 Tailscale 客户端</strong></li></ol><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">wget</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> https://pkgs.tailscale.com/stable/tailscale_1.22.2_amd64.tgz</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  # 下载对应版本</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">tar</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> zxvf</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> tailscale_</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">*</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">.tgz</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">cp</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> tailscale_</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">*</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">/tailscale</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> /usr/bin/tailscale</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">cp</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> tailscale_</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">*</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">/tailscaled</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> /usr/sbin/tailscaled</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">chmod</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> +x</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> /usr/bin/tailscale</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> /usr/sbin/tailscaled</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="2"><li><strong>注册服务并启动</strong></li></ol><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">cp</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> tailscale_</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">*</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">/systemd/tailscaled.service</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> /lib/systemd/system/</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">systemctl</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> enable</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> --now</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> tailscaled</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><ol start="3"><li><strong>连接到 Headscale 服务器</strong></li></ol><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">tailscale</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> up</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> --login-server=http://</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">HEADSCALE_IP</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt;</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">:8080</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> --accept-dns=false</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><pre><code>- 执行后会生成注册链接，在浏览器中打开并在 Headscale 服务端执行类似以下命令完成注册：  
</code></pre><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">headscale</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> nodes</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> register</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> --user</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> &lt;</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">USERNAM</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">E&gt; </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">--key</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> &lt;</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">KE</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">Y&gt;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h4 id="注意事项" tabindex="-1"><a class="header-anchor" href="#注意事项"><span><strong>注意事项</strong>：</span></a></h4><ul><li>若需非交互式注册，可使用预授权密钥：</li></ul><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">tailscale</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> up</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> --login-server=http://</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">HEADSCALE_IP</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt;</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">:8080</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> --authkey</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> &lt;</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">PREAUTH_KE</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">Y&gt;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><hr><h3 id="_2-macos-客户端接入" tabindex="-1"><a class="header-anchor" href="#_2-macos-客户端接入"><span><strong>2. macOS 客户端接入</strong></span></a></h3><h4 id="步骤-1" tabindex="-1"><a class="header-anchor" href="#步骤-1"><span><strong>步骤</strong>：</span></a></h4><ol><li><strong>安装 Tailscale 客户端</strong><ul><li>通过 <a href="https://tailscale.com/download%E4%B8%8B%E8%BD%BD" target="_blank" rel="noopener noreferrer">https://tailscale.com/download下载</a> macOS 版安装包。</li></ul></li><li><strong>修改客户端配置</strong>（可选） <ul><li>编辑配置文件 <code>/etc/default/tailscaled</code>，指定 Headscale 服务器地址。</li></ul></li><li><strong>连接 Headscale</strong></li></ol><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">tailscale</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> up</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> --login-server=http://</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">HEADSCALE_IP</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt;</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">:8080</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><pre><code>- 后续操作与 Linux 类似，需在服务端批准注册。
</code></pre><hr><h3 id="_3-windows-客户端接入" tabindex="-1"><a class="header-anchor" href="#_3-windows-客户端接入"><span><strong>3. Windows 客户端接入</strong></span></a></h3><h4 id="步骤-2" tabindex="-1"><a class="header-anchor" href="#步骤-2"><span><strong>步骤</strong>：</span></a></h4><ol><li><strong>安装 Tailscale</strong><ul><li>下载 Windows 版安装包并运行。</li></ul></li><li><strong>通过命令行连接</strong></li></ol><div class="language-powershell line-numbers-mode" data-highlighter="shiki" data-ext="powershell" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-powershell"><span class="line"><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;">tailscale.exe</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> up </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">--</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">login</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">-</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">server</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">http:</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">//</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&lt;HEADSCALE_IP&gt;:</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">8080</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><pre><code>- 需在服务端执行注册命令。
</code></pre><hr><h3 id="_4-其他平台注意事项" tabindex="-1"><a class="header-anchor" href="#_4-其他平台注意事项"><span><strong>4. 其他平台注意事项</strong></span></a></h3><ul><li><strong>Android/iOS</strong>： <ul><li>官方客户端不支持自定义服务器，需自行编译修改。</li></ul></li><li><strong>OpenBSD/FreeBSD</strong>： <ul><li>与 Linux 步骤类似，需确保内核支持 TUN 设备。</li></ul></li></ul><hr><h3 id="通用配置建议" tabindex="-1"><a class="header-anchor" href="#通用配置建议"><span><strong>通用配置建议</strong></span></a></h3><ol><li><strong>HTTPS 必需性</strong>： <ul><li>生产环境建议通过 Nginx/Caddy 反向代理 Headscale 的 <code>server_url</code> 为 HTTPS，否则部分功能（如 MagicDNS）可能失效。</li></ul></li><li><strong>预授权密钥</strong>： <ul><li>生成一次性或可复用的密钥简化批量部署：</li></ul></li></ol><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">headscale</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> preauthkeys</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> create</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> --user</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> &lt;</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">USE</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">R&gt; </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">--expiry</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 24h</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><ol start="3"><li><strong>防火墙规则</strong>： <ul><li>确保客户端可访问 Headscale 的监听端口（默认 8080）和 DERP 中继端口（如 UDP 3478）。</li></ul></li></ol><hr><h3 id="故障排查" tabindex="-1"><a class="header-anchor" href="#故障排查"><span><strong>故障排查</strong></span></a></h3><ul><li><strong>注册失败</strong>：检查 <code>server_url</code> 是否可达，且服务端日志无报错。</li><li><strong>NAT 穿透失败</strong>：通过 <code>tailscale netcheck</code> 确认是否使用了备用 DERP 中继。</li></ul><blockquote><p>更多客户端管理命令（如查看节点、删除设备）可参考 <code>headscale nodes list</code> 和 <code>headscale nodes delete</code>。</p></blockquote><p>在 Tailscale 中，如果两个节点偶尔处于非 <code>active</code> 状态（如 <code>offline</code> 或 <code>idle</code>），可以通过以下方法手动激活或主动探活：</p><hr><h3 id="_1-强制节点重新连接" tabindex="-1"><a class="header-anchor" href="#_1-强制节点重新连接"><span><strong>1. 强制节点重新连接</strong></span></a></h3><h4 id="方法-1-使用-tailscale-up-重新激活" tabindex="-1"><a class="header-anchor" href="#方法-1-使用-tailscale-up-重新激活"><span><strong>方法 1：使用 <strong><strong><code>tailscale up</code></strong></strong> 重新激活</strong></span></a></h4><p>在非活跃节点上执行：</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">tailscale</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> up</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> --reset</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><ul><li><code>--reset</code> 会强制节点重新连接 Tailscale 网络，并尝试重新建立点对点（P2P）或 DERP 中继连接。</li></ul><h4 id="方法-2-重启-tailscaled-服务" tabindex="-1"><a class="header-anchor" href="#方法-2-重启-tailscaled-服务"><span><strong>方法 2：重启 <strong><strong><code>tailscaled</code></strong></strong> 服务</strong></span></a></h4><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">sudo</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> systemctl</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> restart</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> tailscaled</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  # Linux</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>或（Windows）：</p><div class="language-powershell line-numbers-mode" data-highlighter="shiki" data-ext="powershell" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-powershell"><span class="line"><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;">Restart-Service</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> Tailscale</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><ul><li>适用于长时间未通信导致的状态异常。</li></ul><hr><h3 id="_2-手动触发-nat-穿透检查" tabindex="-1"><a class="header-anchor" href="#_2-手动触发-nat-穿透检查"><span><strong>2. 手动触发 NAT 穿透检查</strong></span></a></h3><p>执行 <code>tailscale netcheck</code> 检查当前网络环境：</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">tailscale</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> netcheck</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><ul><li>输出会显示 NAT 穿透状态（如 <code>UDP blocked</code> 或 <code>DERP relay</code>），帮助判断是否需要调整防火墙或路由器设置。</li></ul><hr><h3 id="_3-使用-ping-或-curl-主动探活" tabindex="-1"><a class="header-anchor" href="#_3-使用-ping-或-curl-主动探活"><span><strong>3. 使用 <strong><strong><code>ping</code></strong></strong> 或 <strong><strong><code>curl</code></strong></strong> 主动探活</strong></span></a></h3><p>在节点 A 上主动访问节点 B 的 Tailscale IP：</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">ping</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 100.64.0.4</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  # 替换为目标节点的 Tailscale IP</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>或测试端口连通性：</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">curl</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> http://100.64.0.4:8080</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  # 测试 HTTP 服务</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><ul><li>主动流量会触发 Tailscale 自动尝试建立连接。</li></ul><hr><h3 id="_4-检查并修复-derp-中继连接" tabindex="-1"><a class="header-anchor" href="#_4-检查并修复-derp-中继连接"><span><strong>4. 检查并修复 DERP 中继连接</strong></span></a></h3><p>如果节点依赖 DERP 中继（如 <code>relay &quot;selfhosted&quot;</code>），需确保自建 DERP 服务器正常运行：</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 在 DERP 服务器上检查服务状态</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">systemctl</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> status</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> headscale</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>如果 DERP 不可用，节点可能无法自动恢复，需修复 DERP 服务或改用官方中继。</li></ul><hr><h3 id="_5-调整-keepalive-设置-高级" tabindex="-1"><a class="header-anchor" href="#_5-调整-keepalive-设置-高级"><span><strong>5. 调整 Keepalive 设置（高级）</strong></span></a></h3><p>在 <code>/etc/default/tailscaled</code>（Linux）或注册表（Windows）中增加 Keepalive 间隔：</p><div class="language-ini line-numbers-mode" data-highlighter="shiki" data-ext="ini" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-ini"><span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#C678DD;">TS_DEBUG_KEEPALIVE</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#98C379;">30s  </span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 默认 60s，缩短可提高活性检测频率</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><ul><li>需重启 <code>tailscaled</code> 生效。</li></ul><hr><h3 id="_6-查看日志定位问题" tabindex="-1"><a class="header-anchor" href="#_6-查看日志定位问题"><span><strong>6. 查看日志定位问题</strong></span></a></h3><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">journalctl</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -u</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> tailscaled</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -f</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  # Linux 实时日志</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>或（Windows）：</p><div class="language-powershell line-numbers-mode" data-highlighter="shiki" data-ext="powershell" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-powershell"><span class="line"><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;">Get-EventLog</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> -</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">LogName Application </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">-</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">Source Tailscale</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">*</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> -</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">Newest </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">10</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><ul><li>关注 <code>magicsock</code> 或 <code>derp</code> 相关错误，如 <code>DERP reconnect failed</code>。</li></ul><hr><h3 id="总结建议" tabindex="-1"><a class="header-anchor" href="#总结建议"><span><strong>总结建议</strong></span></a></h3><ol><li><strong>临时恢复</strong>：优先使用 <code>tailscale up --reset</code> 或重启服务。</li><li><strong>长期稳定</strong>：检查防火墙/NAT 规则，确保 UDP 41641 和 DERP 端口（如 3478）开放。</li><li><strong>监控工具</strong>：结合 <code>tailscale status --json</code> 输出自动化监控节点状态。</li></ol><blockquote><p>若问题持续，提交诊断报告：<code>tailscale bugreport</code>，并附上日志。</p></blockquote><hr><h3 id="🏢-四、企业级扩展场景" tabindex="-1"><a class="header-anchor" href="#🏢-四、企业级扩展场景"><span>🏢 四、企业级扩展场景</span></a></h3><ol><li><p><strong>混合云组网</strong></p><p>打通 AWS/Azure 云主机与本地数据中心，替代专线 VPN，通过 ACL 限制云数据库仅内网访问。</p></li><li><p><strong>零信任安全体系</strong></p><ul><li>设备双向认证（WireGuard 密钥 + 用户身份）；</li><li>微隔离策略（如研发组仅能访问测试环境 IP 段）。</li></ul></li><li><p><strong>IoT 设备互联</strong></p><p>嵌入式设备（OpenWRT 路由器）接入，实现远程管理与安全更新。</p></li></ol><hr><h3 id="⚖️-五、对比选型建议" tabindex="-1"><a class="header-anchor" href="#⚖️-五、对比选型建议"><span>⚖️ 五、对比选型建议</span></a></h3><table><thead><tr><th><strong>方案</strong></th><th><strong>自托管复杂度</strong></th><th><strong>协议性能</strong></th><th><strong>企业级特性</strong></th><th><strong>适用场景</strong></th></tr></thead><tbody><tr><td><strong>Headscale</strong></td><td>中 ★★☆</td><td>WireGuard（用户态）</td><td>多租户隔离、ACL 强控</td><td>中大型企业、合规严格场景</td></tr><tr><td><strong>NetBird</strong></td><td>高 ★★★</td><td>WireGuard（内核态）</td><td>官方支持完善</td><td>需开箱即用、轻量级私有部署</td></tr><tr><td><strong>ZeroTier</strong></td><td>低 ★☆☆</td><td>自有协议</td><td>免费版功能受限</td><td>个人或小型团队快速组网</td></tr></tbody></table><blockquote><p>✅ <strong>Headscale 核心优势</strong>：</p></blockquote><ul><li><strong>完全自主可控</strong>：从数据存储到流量中转全程私有化；</li><li><strong>成本优化</strong>：无需按设备付费，中继服务器可复用现有资源；</li><li><strong>生态兼容</strong>：复用 Tailscale 客户端，降低迁移成本。</li></ul><hr><h3 id="⚠️-六、注意事项" tabindex="-1"><a class="header-anchor" href="#⚠️-六、注意事项"><span>⚠️ 六、注意事项</span></a></h3><ol><li><strong>域名与证书</strong>：必须配置有效域名 + HTTPS（否则客户端注册失败），可通过 Nginx/Caddy 反向代理解决。</li><li><strong>NAT 穿透优化</strong>：若直连失败，需检查防火墙放行 UDP 3478 及 49152-65535 端口，或强化 DERP 中继。</li><li><strong>高可用设计</strong>：生产环境建议 PostgreSQL 替代 SQLite，并部署多副本 Headscale 服务。</li></ol><hr><p><strong>总结</strong>：Headscale 是当前私有化组网方案中<strong>平衡功能、控制权与协议性能的优选</strong>，尤其适合需定制安全策略、规避云服务依赖的企业场景。结合可视化工具 <a href="https://github.com/next-admin/headscale-admin" target="_blank" rel="noopener noreferrer">https://github.com/next-admin/headscale-admin</a> 可进一步提升管理效率。部署详见 <a href="https://headscale.net/" target="_blank" rel="noopener noreferrer">https://headscale.net/</a> 及 <a href="https://github.com/juanfont/headscale%E3%80%82" target="_blank" rel="noopener noreferrer">https://github.com/juanfont/headscale。</a></p><h2 id="八、高级选项-advertise-routes-和-advertise-exit-node" tabindex="-1"><a class="header-anchor" href="#八、高级选项-advertise-routes-和-advertise-exit-node"><span>八、高级选项--advertise-routes 和 -advertise-exit-node</span></a></h2><p>在 Tailscale/Headscale 中，<code>--advertise-routes</code> 和 <code>--advertise-exit-node</code> 是两个关键的高级选项，用于扩展虚拟局域网的网络功能。以下是它们的核心作用和使用场景：</p><hr><h3 id="_1-advertise-routes-子网路由通告" tabindex="-1"><a class="header-anchor" href="#_1-advertise-routes-子网路由通告"><span>1. <strong><code>--advertise-routes</code>****：子网路由通告</strong></span></a></h3><h4 id="功能" tabindex="-1"><a class="header-anchor" href="#功能"><span><strong>功能</strong></span></a></h4><p>允许节点将其所在的<strong>物理局域网网段</strong>（如家庭/公司内网）共享给 Tailscale 网络中的其他设备，使这些设备能通过虚拟网络访问实际物理网络。</p><h4 id="使用场景" tabindex="-1"><a class="header-anchor" href="#使用场景"><span><strong>使用场景</strong></span></a></h4><ul><li><p><strong>访问家庭NAS</strong>：</p><p>家庭路由器运行 Tailscale 并通告 <code>192.168.1.0/24</code>，外出的手机/笔记本通过 Tailscale 直接访问家庭内网设备，无需额外 VPN 配置。</p></li><li><p><strong>企业多站点互联</strong>：</p><p>分支机构的路由器分别通告 <code>10.1.0.0/24</code> 和 <code>10.2.0.0/24</code>，实现跨地域局域网互通。</p></li><li><p><strong>混合云组网</strong>：</p><p>VPS 通告云服务器私有网段（如 <code>172.16.0.0/16</code>），本地设备直接访问云内资源。</p></li></ul><h4 id="配置示例" tabindex="-1"><a class="header-anchor" href="#配置示例"><span><strong>配置示例</strong></span></a></h4><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 家庭路由器通告本地网段</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">tailscale</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> up</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> --advertise-routes=192.168.1.0/24</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> --login-server=https://headscale.example.com</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># Headscale 启用路由（需管理员操作）</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">headscale</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> routes</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> enable</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -n</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> &lt;</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">命名空</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">间&gt; &lt;</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">节点</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">名&gt; </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">192.168.1.0/24</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="注意事项-1" tabindex="-1"><a class="header-anchor" href="#注意事项-1"><span><strong>注意事项</strong></span></a></h4><ul><li>需在 Headscale 控制端手动审批路由（默认关闭）。</li><li>通告的网段不能与 Tailscale 虚拟 IP 段（如 <code>100.64.0.0/10</code>）冲突。</li></ul><hr><h3 id="_2-advertise-exit-node-出口节点通告" tabindex="-1"><a class="header-anchor" href="#_2-advertise-exit-node-出口节点通告"><span>2. <strong><code>--advertise-exit-node</code>****：出口节点通告</strong></span></a></h3><h4 id="功能-1" tabindex="-1"><a class="header-anchor" href="#功能-1"><span><strong>功能</strong></span></a></h4><p>将当前节点设为<strong>流量出口</strong>，允许其他 Tailscale 设备通过该节点访问互联网，类似 VPN 的全局代理模式。</p><h4 id="使用场景-1" tabindex="-1"><a class="header-anchor" href="#使用场景-1"><span><strong>使用场景</strong></span></a></h4><ul><li><p><strong>安全远程办公</strong>：</p><p>公司内网设备作为出口节点，员工在外通过该节点访问互联网，流量加密且隐藏真实 IP。</p></li><li><p><strong>绕过地域限制</strong>：</p><p>海外 VPS 作为出口节点，实现科学上网（需遵守当地法律）。</p></li><li><p><strong>移动设备共享蜂窝IP</strong>：</p><p>手机开启出口节点模式，测试机通过手机流量动态切换 IP（如测试短信接口防刷）。</p></li></ul><h4 id="配置示例-1" tabindex="-1"><a class="header-anchor" href="#配置示例-1"><span><strong>配置示例</strong></span></a></h4><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 将当前节点设为出口节点</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">tailscale</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> up</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> --advertise-exit-node</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> --login-server=https://headscale.example.com</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 其他设备使用该出口节点</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">tailscale</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> up</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> --exit-node=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">出口节点IP</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt;</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> --exit-node-allow-lan-access</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="注意事项-2" tabindex="-1"><a class="header-anchor" href="#注意事项-2"><span><strong>注意事项</strong></span></a></h4><ul><li>出口节点需开启 IP 转发（Linux 执行 <code>echo 1 &gt; /proc/sys/net/ipv4/ip_forward</code>）。</li><li>可能显著增加出口节点的流量负载和电池消耗（移动设备）。</li></ul><hr><h3 id="_3-组合使用案例" tabindex="-1"><a class="header-anchor" href="#_3-组合使用案例"><span>3. <strong>组合使用案例</strong></span></a></h3><h4 id="家庭网络枢纽" tabindex="-1"><a class="header-anchor" href="#家庭网络枢纽"><span><strong>家庭网络枢纽</strong></span></a></h4><ul><li><strong>路由器配置</strong>：</li></ul><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">tailscale</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> up</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> --advertise-routes=192.168.1.0/24</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> --advertise-exit-node</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><pre><code>- 其他设备可访问家庭内网（如 NAS），同时通过家庭宽带出口上网。  
</code></pre><ul><li><p><strong>手机临时切换IP</strong>：</p><p>动态启用手机作为出口节点，测试机通过 <code>--exit-node</code> 快速更换公网 IP。</p></li></ul><hr><h3 id="_4-常见问题" tabindex="-1"><a class="header-anchor" href="#_4-常见问题"><span>4. <strong>常见问题</strong></span></a></h3><ul><li><p><strong>路由未生效</strong>：</p><p>检查 Headscale 控制端是否启用路由（<code>headscale routes list</code>）。</p></li><li><p><strong>流量泄露</strong>：</p><p>若出口节点未正确配置防火墙，可能导致本地网络暴露（建议搭配 <code>--exit-node-allow-lan-access=false</code>）。</p></li></ul><p>通过这两个选项，Tailscale/Headscale 能实现从简单的设备互联到复杂的混合网络架构，满足灵活组网需求。</p><h2 id="九、-exit-node-如果开启切换出口后-是不是默认所有请求-都走-新的出口了" tabindex="-1"><a class="header-anchor" href="#九、-exit-node-如果开启切换出口后-是不是默认所有请求-都走-新的出口了"><span>九、--exit-node 如果开启切换出口后， 是不是默认所有请求，都走 新的出口了？</span></a></h2><p>在 Tailscale/Headscale 网络中，当您通过 <code>--exit-node</code> 参数指定某个节点为出口节点后，<strong>默认情况下所有互联网流量都会通过该出口节点转发</strong>，但本地局域网（LAN）流量是否经过出口节点取决于额外配置。以下是具体规则和注意事项：</p><hr><h3 id="_1-默认行为-全局流量重定向" tabindex="-1"><a class="header-anchor" href="#_1-默认行为-全局流量重定向"><span>1. <strong>默认行为：全局流量重定向</strong></span></a></h3><ul><li><p><strong>所有互联网流量</strong>：</p><p>启用出口节点后，设备的所有对外互联网请求（如访问百度、GitHub）默认会通过出口节点的公网 IP 流出，您的本地 IP 会被隐藏。</p></li><li><p><strong>配置命令示例</strong>：</p></li></ul><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">tailscale</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> up</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> --exit-node=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">出口节点IP</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><hr><h3 id="_2-局域网流量的特殊处理" tabindex="-1"><a class="header-anchor" href="#_2-局域网流量的特殊处理"><span>2. <strong>局域网流量的特殊处理</strong></span></a></h3><ul><li><p><strong>默认不重定向局域网流量</strong>：</p><p>Tailscale 默认不会将本地局域网（如 <code>192.168.1.0/24</code>）的流量转发到出口节点，而是直接通过本地网络通信。</p></li><li><p><strong>允许局域网流量重定向</strong>：</p><p>若需强制所有流量（包括局域网）都经过出口节点，需显式添加 <code>--exit-node-allow-lan-access=true</code> 参数：</p></li></ul><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">tailscale</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> up</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> --exit-node=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">出口节点IP</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt;</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> --exit-node-allow-lan-access=true</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><hr><h3 id="_3-例外情况" tabindex="-1"><a class="header-anchor" href="#_3-例外情况"><span>3. <strong>例外情况</strong></span></a></h3><ul><li><p><strong>Tailscale 虚拟网络流量</strong>：</p><p>与其他 Tailscale 节点的通信（如 <code>100.x.y.z</code>）始终为点对点直连（或通过 DERP 中继），不受出口节点影响。</p></li><li><p><strong>按需排除特定流量</strong>：</p><p>可通过路由策略或 ACL 规则限制某些目标 IP 不经过出口节点（需手动配置）。</p></li></ul><hr><h3 id="_4-验证流量路径" tabindex="-1"><a class="header-anchor" href="#_4-验证流量路径"><span>4. <strong>验证流量路径</strong></span></a></h3><ul><li><p><strong>检查当前路由</strong>：</p><p>执行以下命令确认流量走向：</p></li></ul><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">tailscale</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> status</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> --exit-node</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><pre><code>输出中会显示 \`Exit node: &lt;IP&gt;\` 和流量统计。
</code></pre><ul><li><p><strong>测试公网 IP</strong>：</p><p>访问 <a href="https://ipv4.icanhazip.com" target="_blank" rel="noopener noreferrer">https://ipv4.icanhazip.com</a> 确认显示的 IP 是否为出口节点的公网 IP。</p></li></ul><hr><h3 id="_5-注意事项" tabindex="-1"><a class="header-anchor" href="#_5-注意事项"><span>5. <strong>注意事项</strong></span></a></h3><ul><li><p><strong>性能影响</strong>：</p><p>出口节点可能成为瓶颈，尤其是高延迟或低带宽场景（如跨国节点）。</p></li><li><p><strong>安全风险</strong>：</p><p>若出口节点被入侵，所有流量可能被监听，建议仅信任自建节点。</p></li><li><p><strong>移动设备耗电</strong>：</p><p>手机作为出口节点时，电池消耗会显著增加。</p></li></ul><hr><h3 id="总结" tabindex="-1"><a class="header-anchor" href="#总结"><span>总结</span></a></h3><ul><li><strong>默认生效范围</strong>：仅互联网流量，不包括本地局域网。</li><li><strong>全流量重定向</strong>：需额外启用 <code>--exit-node-allow-lan-access</code>。</li><li><strong>Tailscale 节点间流量</strong>：始终独立于出口节点。</li></ul><p>如需临时关闭出口节点，运行 <code>tailscale up --exit-node=&quot;&quot;</code>。</p><h2 id="十、如何实现-类似-socks5的效果-设备a-通过socks5-直接访问设备b的网络。" tabindex="-1"><a class="header-anchor" href="#十、如何实现-类似-socks5的效果-设备a-通过socks5-直接访问设备b的网络。"><span>十、如何实现 类似 socks5的效果？ 设备A，通过socks5 直接访问设备B的网络。</span></a></h2><p>以下是实现设备A通过SOCKS5代理直接访问设备B网络的几种方法，结合不同技术方案和适用场景：</p><hr><h3 id="一、基于tailscale的虚拟局域网方案" tabindex="-1"><a class="header-anchor" href="#一、基于tailscale的虚拟局域网方案"><span>一、<strong>基于Tailscale的虚拟局域网方案</strong></span></a></h3><ol><li><strong>核心原理</strong><ul><li>使用Tailscale为设备A和设备B创建加密的虚拟局域网（基于WireGuard），所有设备分配<code>100.x.x.x</code>固定IP，无需公网IP或端口转发。</li><li>通过子网路由（<code>--advertise-routes</code>）将设备B的本地网络暴露给设备A，实现类似SOCKS5的透明代理效果。</li></ul></li><li><strong>配置步骤</strong><ul><li><strong>设备B（服务端）</strong>：</li></ul></li></ol><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 启用子网路由（假设设备B的局域网为192.168.1.0/24）</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">tailscale</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> up</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> --advertise-routes=192.168.1.0/24</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> --login-server=https://headscale.example.com</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><pre><code>- **设备A（客户端）**：  
</code></pre><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 接受子网路由并连接</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">tailscale</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> up</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> --accept-routes</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> --exit-node=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">设备B的TailscaleIP</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><pre><code>- **验证**：设备A可直接访问设备B所在局域网的任何服务（如\`192.168.1.100:8080\`）。
</code></pre><ol start="3"><li><strong>优势</strong><ul><li>零配置NAT穿透，自动建立P2P直连或通过DERP中继。</li><li>端到端加密，无需额外代理工具。</li></ul></li></ol><hr><h3 id="二、传统socks5代理搭建方案" tabindex="-1"><a class="header-anchor" href="#二、传统socks5代理搭建方案"><span>二、<strong>传统SOCKS5代理搭建方案</strong></span></a></h3><ol><li><strong>在设备B上部署SOCKS5服务</strong><ul><li><strong>Python实现</strong>（需设备B安装Python）：</li></ul></li></ol><div class="language-python line-numbers-mode" data-highlighter="shiki" data-ext="python" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-python"><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">import</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> socket, socks</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">socks.</span><span style="--shiki-light:#383A42;--shiki-dark:#61AFEF;">set_default_proxy</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(socks.</span><span style="--shiki-light:#383A42;--shiki-dark:#D19A66;">SOCKS5</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;0.0.0.0&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">1080</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)  </span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 监听1080端口</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">socket.socket </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> socks.socksocket</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><pre><code>- **专业工具**：如\`Dante\`或\`3proxy\`，支持高性能并发。
</code></pre><ol start="2"><li><strong>设备A配置代理</strong><ul><li><strong>命令行工具</strong>：</li></ul></li></ol><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">curl</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> --socks5</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> &lt;</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">设备B_I</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">P&gt;</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">:1080</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> http://内网服务地址</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><pre><code>- **全局系统代理**：在设备A的网络设置中填写SOCKS5代理地址（设备B的IP和端口）。
</code></pre><ol start="3"><li><strong>注意事项</strong><ul><li>需在设备B的防火墙放行SOCKS5端口（如1080）。</li><li>若设备B在NAT后，需配置路由器端口转发或使用内网穿透工具（如frp）。</li></ul></li></ol><hr><h3 id="三、ssh隧道转socks5-无需额外安装" tabindex="-1"><a class="header-anchor" href="#三、ssh隧道转socks5-无需额外安装"><span>三、<strong>SSH隧道转SOCKS5（无需额外安装）</strong></span></a></h3><ol><li><strong>通过SSH动态端口转发</strong><ul><li>在设备A执行：</li></ul></li></ol><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">ssh</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -D</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 1080</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> user@</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">设备B_I</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">P&gt;  </span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 本地1080端口映射为设备B的SOCKS5代理</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><pre><code>- 设备A的应用程序配置SOCKS5代理为\`127.0.0.1:1080\`，所有流量通过设备B转发。
</code></pre><ol start="2"><li><strong>适用场景</strong><ul><li>设备B需运行SSH服务（默认22端口）。</li><li>适合临时访问或安全要求高的环境（SSH自带加密）。</li></ul></li></ol><hr><h3 id="四、docker容器化socks5服务" tabindex="-1"><a class="header-anchor" href="#四、docker容器化socks5服务"><span>四、<strong>Docker容器化SOCKS5服务</strong></span></a></h3><ol><li><strong>在设备B运行SOCKS5容器</strong></li></ol><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">docker</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> run</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -d</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> --name=socks5</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -p</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 1080:1080</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> serjs/go-socks5-proxy</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><ol start="2"><li><strong>设备A通过容器IP访问</strong><ul><li>若设备B的Docker网络为桥接模式，需映射宿主机端口（如<code>-p 1080:1080</code>）。</li></ul></li></ol><hr><h3 id="方案对比" tabindex="-1"><a class="header-anchor" href="#方案对比"><span><strong>方案对比</strong></span></a></h3><table><thead><tr><th>方案</th><th>适用场景</th><th>复杂度</th><th>安全性</th><th>性能</th></tr></thead><tbody><tr><td>Tailscale子网路由</td><td>长期稳定访问，多设备互通</td><td>低</td><td>高（加密）</td><td>高（P2P）</td></tr><tr><td>传统SOCKS5代理</td><td>需兼容老旧应用或特定协议</td><td>中</td><td>依赖配置</td><td>中</td></tr><tr><td>SSH隧道</td><td>临时访问，设备已开放SSH</td><td>低</td><td>高</td><td>中</td></tr><tr><td>Docker SOCKS5</td><td>快速部署，环境隔离</td><td>中</td><td>中</td><td>中</td></tr></tbody></table><hr><h3 id="推荐选择" tabindex="-1"><a class="header-anchor" href="#推荐选择"><span><strong>推荐选择</strong></span></a></h3><ul><li><strong>优先Tailscale</strong>：若设备B为家庭NAS或企业内网，Tailscale的子网路由最便捷安全。</li><li><strong>临时需求</strong>：SSH隧道或轻量SOCKS5容器更灵活。</li><li><strong>跨平台兼容</strong>：传统SOCKS5代理适配性最广（如支持游戏客户端）。</li></ul>`,248)])])}const k=i(n,[["render",t]]),p=JSON.parse('{"path":"/tld/net/headscale.html","title":"Headscale","lang":"zh-CN","frontmatter":{"description":"Headscale Headscale 是一款开源自托管的 Tailscale 一、网络主流工具选型对比 深入学习https://headscale.net/stable/ref/configuration/ Usage https://headscale.net/stable/usage/getting-started/ 本身支持Remote CLI...","head":[["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"Headscale\\",\\"image\\":[\\"\\"],\\"dateModified\\":\\"2025-09-10T14:21:13.000Z\\",\\"author\\":[{\\"@type\\":\\"Person\\",\\"name\\":\\"SecCMD\\",\\"url\\":\\"https://www.seccmd.net\\"}]}"],["meta",{"property":"og:url","content":"https://www.seccmd.net/tld/net/headscale.html"}],["meta",{"property":"og:site_name","content":"明剑实验室"}],["meta",{"property":"og:title","content":"Headscale"}],["meta",{"property":"og:description","content":"Headscale Headscale 是一款开源自托管的 Tailscale 一、网络主流工具选型对比 深入学习https://headscale.net/stable/ref/configuration/ Usage https://headscale.net/stable/usage/getting-started/ 本身支持Remote CLI..."}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:locale","content":"zh-CN"}],["meta",{"property":"og:updated_time","content":"2025-09-10T14:21:13.000Z"}],["meta",{"property":"article:modified_time","content":"2025-09-10T14:21:13.000Z"}]]},"git":{"createdTime":1757419694000,"updatedTime":1757514073000,"contributors":[{"name":"fireadm","username":"fireadm","email":"iwanwu@hotmail.com","commits":2,"url":"https://github.com/fireadm"}]},"readingTime":{"minutes":19.43,"words":5829},"filePathRelative":"tld/net/headscale.md","autoDesc":true}');export{k as comp,p as data};
