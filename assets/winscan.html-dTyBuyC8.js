import{_ as n}from"./plugin-vue_export-helper-DlAUqK2U.js";import{c as a,f as e,o as i}from"./app-DXpCwEIF.js";const l={};function p(t,s){return i(),a("div",null,[...s[0]||(s[0]=[e(`<h1 id="winscan" tabindex="-1"><a class="header-anchor" href="#winscan"><span>Winscan</span></a></h1><p>一键Windows应急响应检测脚本</p><h4 id="实现功能" tabindex="-1"><a class="header-anchor" href="#实现功能"><span>实现功能：</span></a></h4><hr><p>说明：运行本脚本需要管理员权限。</p><p>信息收集相关：</p><ul><li>操作系统信息</li><li>系统补丁情况(*)</li><li>系统账户和用户组(*)</li><li>域密码策略</li><li>管理员组</li><li>用户上次登录时间</li><li>重要的注册表项</li><li>RDP保存的凭证</li><li>是否开启远程桌面服务</li><li>本机共享列表(*)</li><li>系统启动信息(*)</li><li>已安装的反病毒软件</li><li>防火墙配置(*)</li><li>Defender检测到的活动和过去的恶意软件威胁</li><li>防火墙日志和系统日志evtx收集</li><li>已安装软件(*)</li><li>计划任务(*)</li><li>服务状态(*)</li><li>自启动服务</li><li>自启动目录</li><li>注册表启动项(*)</li><li>网络连接（ipc$ 命名管道连接）</li><li>是否启用Windows剪切板历史记录</li><li>用户登录初始化、管理员自动登录</li><li>Logon Scripts</li><li>屏幕保护程序</li><li>AppInit_DLLs</li><li>COM劫持(*)</li><li>shim数据库是否被劫持</li><li>进程注入</li><li>exe文件启动相关注册表</li><li>Lsa</li><li>映像劫持</li><li>接受最终用户许可协议的程序</li><li>安全模式启动相关注册表</li><li>powershell命令记录(*)</li><li>IE浏览器记录</li><li>certutil下载记录</li><li>最近访问的文件(*)</li><li>&quot;我的电脑、此电脑、计算机&quot;的任意文件夹地址栏内的历史记录</li><li>【运行】的历史记录</li><li>网络连接情况(*)</li><li>DNS缓存记录(*)</li><li>进程(*)</li><li>系统日志是否开启</li></ul><p>调查取证相关：</p><ul><li>SAM、SECURITY、SYSTEM(*)</li><li>Sysmon 日志(*)</li><li>SRUM (System Resource Usage Monitor)(*)</li><li>MUICache(*)</li><li>ShimCache(*)</li><li>Prefetch(*)</li><li>系统日志(*)</li></ul><h2 id="winscan-bat" tabindex="-1"><a class="header-anchor" href="#winscan-bat"><span>Winscan.bat</span></a></h2><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span>@echo off</span></span>
<span class="line"><span>color 0f</span></span>
<span class="line"><span>::call:colorys调用底部:colorys</span></span>
<span class="line"><span>::02为颜色设置，0指定输出文字背景颜色，2指定文字颜色</span></span>
<span class="line"><span>::输出不能包含符号 / : ? * &quot; &gt; &lt; | \\</span></span>
<span class="line"><span>cd %~dp0</span></span>
<span class="line"><span>for /f &quot;delims=&quot; %%A in (&#39;dir /s /b %WINDIR%\\system32\\*htable.xsl&#39;) do set &quot;var=%%A&quot;</span></span>
<span class="line"><span>if not exist ./eventlog/ (md eventlog)</span></span>
<span class="line"><span>if not exist ./schtasks/ (md schtasks)</span></span>
<span class="line"><span>if not exist ./Prefetch/ (md Prefetch)</span></span>
<span class="line"><span>if not exist ./hive/ (md hive)</span></span>
<span class="line"><span>if not exist ./CryptnetURLCache/ (md CryptnetURLCache)</span></span>
<span class="line"><span>if exist out.html (del out.html)</span></span>
<span class="line"><span>::reg query HKLM\\SAM\\SAM\\Domains\\Account\\Users\\Names</span></span>
<span class="line"><span>call:colorys 0A &quot;[+] 正在查询系统相关信息：&quot;</span></span>
<span class="line"><span>@echo.</span></span>
<span class="line"><span>wmic OS get Caption,CSDVersion,OSArchitecture,Version</span></span>
<span class="line"><span>wmic computersystem list brief</span></span>
<span class="line"><span>call:colorys 0A &quot;[+] 正在查询系统补丁情况，并写入文件：&quot;</span></span>
<span class="line"><span>wmic qfe get Description,HotFixID,InstalledOn /format:&quot;%var%&quot; &gt;&gt; out.html</span></span>
<span class="line"><span>@echo.</span></span>
<span class="line"><span>call:colorys 0A &quot;[+] 正在查询系统账户和用户组，并写入文件：&quot;</span></span>
<span class="line"><span>@echo.</span></span>
<span class="line"><span>wmic UserAccount get name,description,sid,disabled</span></span>
<span class="line"><span>wmic UserAccount get Description,Disabled,LocalAccount,Lockout,Name,PasswordChangeable,PasswordExpires,PasswordRequired,SID,Status /format:&quot;%var%&quot; &gt;&gt; out.html</span></span>
<span class="line"><span>wmic group get Description,Domain,Name,SID,Status /format:&quot;%var%&quot; &gt;&gt; out.html</span></span>
<span class="line"><span>wmic volume get Label,DeviceID,DriveLetter,FileSystem,FreeSpace /format:&quot;%var%&quot; &gt;&gt; out.html</span></span>
<span class="line"><span>call:colorys 0A &quot;[+] 正在检查域密码策略：&quot;</span></span>
<span class="line"><span>@echo.</span></span>
<span class="line"><span>Net accounts /domain</span></span>
<span class="line"><span>@echo.</span></span>
<span class="line"><span>call:colorys 0A &quot;[+] 检查管理员组：&quot;</span></span>
<span class="line"><span>@echo.</span></span>
<span class="line"><span>net localgroup administrators</span></span>
<span class="line"><span>net group &quot;domain admins&quot; /domain</span></span>
<span class="line"><span>@echo.</span></span>
<span class="line"><span>call:colorys 0A &quot;[+] 检查用户上次登录时间：&quot;</span></span>
<span class="line"><span>@echo.</span></span>
<span class="line"><span>wmic netlogin get name,lastlogon,badpasswordcount</span></span>
<span class="line"><span>call:colorys 0A &quot;[+] 检查重要的注册表项：&quot;</span></span>
<span class="line"><span>@echo.</span></span>
<span class="line"><span>::SSP</span></span>
<span class="line"><span>reg query hklm\\system\\currentcontrolset\\control\\lsa /v &quot;Security Packages&quot;</span></span>
<span class="line"><span>::WDigest，1代表开启，0代表明文密码不会出现在内存中</span></span>
<span class="line"><span>reg query HKLM\\SYSTEM\\CurrentControlSet\\Control\\SecurityProviders\\WDigest /v UseLogonCredential</span></span>
<span class="line"><span>@echo.</span></span>
<span class="line"><span>call:colorys 0A &quot;[+] 检查RDP保存的凭证：&quot;</span></span>
<span class="line"><span>@echo.</span></span>
<span class="line"><span>reg query &quot;HKCU\\Software\\Microsoft\\Terminal Server Client\\Servers&quot; /s</span></span>
<span class="line"><span>reg query &quot;HKCU\\Software\\Microsoft\\Terminal Server Client\\Servers&quot; /s &gt; rdp_certificate.txt</span></span>
<span class="line"><span>call:colorys 0A &quot;[+] 检查是否开启远程桌面服务：&quot;</span></span>
<span class="line"><span>::开启则返回0x00</span></span>
<span class="line"><span>reg query &quot;HKLM\\SYSTEM\\CurrentControlSet\\Control\\Terminal Server&quot; /v fDenyTSConnections</span></span>
<span class="line"><span>call:colorys 0A &quot;[+] 检查本机共享列表，并写入文件：&quot;</span></span>
<span class="line"><span>net share</span></span>
<span class="line"><span>Wmic share get name,path,status /format:&quot;%var%&quot; &gt;&gt; out.html</span></span>
<span class="line"><span>call:colorys 0A &quot;[+] 检查系统启动信息，并写入文件：&quot;</span></span>
<span class="line"><span>@echo.</span></span>
<span class="line"><span>wmic startup get command,caption,Location,User</span></span>
<span class="line"><span>wmic startup get command,caption,Location,User /format:&quot;%var%&quot; &gt;&gt; out.html</span></span>
<span class="line"><span>@echo.</span></span>
<span class="line"><span>call:colorys 0A &quot;[+] 检查已安装反病毒软件：&quot;</span></span>
<span class="line"><span>@echo.</span></span>
<span class="line"><span>wmic /namespace:\\\\root\\securitycenter2 path antivirusproduct GET displayName,productState, pathToSignedProductExe</span></span>
<span class="line"><span>@echo.</span></span>
<span class="line"><span>call:colorys 0A &quot;[+] 检查防火墙配置，并写入文件：&quot;</span></span>
<span class="line"><span>netsh firewall show config</span></span>
<span class="line"><span>netsh firewall show config &gt; firewall_config.txt</span></span>
<span class="line"><span>@echo.</span></span>
<span class="line"><span>call:colorys 0A &quot;[+] 检查Defender检测到的活动和过去的恶意软件威胁：&quot;</span></span>
<span class="line"><span>@echo.</span></span>
<span class="line"><span>powershell Get-MpThreatDetection</span></span>
<span class="line"><span>call:colorys 0A &quot;[+] 正在拷贝防火墙日志和evtx：&quot;</span></span>
<span class="line"><span>@echo.</span></span>
<span class="line"><span>if exist %windir%\\system32\\logfiles\\firewall\\pfirewall.log (copy /Y %windir%\\system32\\logfiles\\firewall\\pfirewall.log)</span></span>
<span class="line"><span>copy /Y &quot;C:\\Windows\\System32\\winevt\\Logs\\Microsoft-Windows-Windows Defender%%4Operational.evtx&quot; .\\eventlog\\</span></span>
<span class="line"><span>@echo.</span></span>
<span class="line"><span>call:colorys 0A &quot;[+] 检查已安装软件，并写入文件：&quot;</span></span>
<span class="line"><span>@echo.</span></span>
<span class="line"><span>reg query HKLM\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Uninstall /s /v DisplayName | findstr DisplayName</span></span>
<span class="line"><span>wmic PRODUCT get Description,InstallDate,InstallLocation,Vendor,Version /format:&quot;%var%&quot; &gt;&gt; out.html</span></span>
<span class="line"><span>@echo.</span></span>
<span class="line"><span>call:colorys 0A &quot;[+] 检查计划任务，拷贝日志和计划任务文件&quot;</span></span>
<span class="line"><span>reg query &quot;HKLM\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Schedule\\TaskCache\\Tree&quot;</span></span>
<span class="line"><span>schtasks /query /fo LIST /v &gt; .\\schtasks\\schtasks.txt</span></span>
<span class="line"><span>for %%i in (C:\\Windows\\System32\\Tasks\\*) do copy /Y %%i schtasks\\</span></span>
<span class="line"><span>::for %%i in (C:\\Windows\\System32\\winevt\\Logs\\Microsoft-Windows-TaskSche*) do copy /Y %%i schtasks\\</span></span>
<span class="line"><span>copy /Y C:\\Windows\\System32\\winevt\\Logs\\Microsoft-Windows-TaskScheduler%%4Operational.evtx .\\eventlog\\</span></span>
<span class="line"><span>copy /Y C:\\Windows\\System32\\winevt\\Logs\\Microsoft-Windows-SMBServer%%4Security.evtx .\\eventlog\\</span></span>
<span class="line"><span>@echo.</span></span>
<span class="line"><span>call:colorys 0A &quot;[+] 检查服务状态，并写入文件：&quot;</span></span>
<span class="line"><span>powershell Get-Service</span></span>
<span class="line"><span>powershell $aa=&quot;gwmi win32_service | ft -Property  Name, DisplayName, PathName, User, State &gt; service.txt&quot;;$aa</span></span>
<span class="line"><span>wmic service get Caption,Name,PathName,ServiceType,Started,StartMode,StartName /format:&quot;%var%&quot; &gt;&gt; out.html</span></span>
<span class="line"><span>call:colorys 0A &quot;[+] 检查自启动服务：&quot;</span></span>
<span class="line"><span>@echo.</span></span>
<span class="line"><span>::RunSrvicese:win7、win10、2012</span></span>
<span class="line"><span>reg query HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\RunServicesOnce</span></span>
<span class="line"><span>reg query HKLM\\Software\\Microsoft\\Windows\\CurrentVersion\\RunServicesOnce</span></span>
<span class="line"><span>reg query HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\RunServices</span></span>
<span class="line"><span>reg query HKLM\\Software\\Microsoft\\Windows\\CurrentVersion\\RunServices</span></span>
<span class="line"><span>reg query HKCU\\SOFTWARE\\Microsoft\\Windows\\Currention\\RunOnce</span></span>
<span class="line"><span>reg query HKLM\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\RunOnceVers</span></span>
<span class="line"><span>@echo.</span></span>
<span class="line"><span>call:colorys 0A &quot;[+] 检查自启动目录：&quot;</span></span>
<span class="line"><span>@echo.</span></span>
<span class="line"><span>dir /a &quot;%APPDATA%\\Microsoft\\Windows\\Start Menu\\Programs\\Startup&quot;</span></span>
<span class="line"><span>dir /a &quot;C:\\ProgramData\\Microsoft\\Windows\\Start Menu\\Programs\\StartUp&quot;</span></span>
<span class="line"><span>dir /a &quot;%SystemDrive%\\Documents and Settings\\All Users\\Start Menu\\Programs\\Startup&quot;</span></span>
<span class="line"><span>@echo.</span></span>
<span class="line"><span>call:colorys 0A &quot;[+] 检查注册表启动项，写入文件中：&quot;</span></span>
<span class="line"><span>@echo.</span></span>
<span class="line"><span>reg query HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\run &gt;qidong.txt</span></span>
<span class="line"><span>reg query HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\RunOnce &gt;&gt;qidong.txt</span></span>
<span class="line"><span>reg query HKLM\\Software\\Microsoft\\Windows\\CurrentVersion\\Run &gt;&gt;qidong.txt</span></span>
<span class="line"><span>reg query HKLM\\Software\\Microsoft\\Windows\\CurrentVersion\\Runonce &gt;&gt;qidong.txt</span></span>
<span class="line"><span>reg query HKLM\\SOFTWARE\\WOW6432Node\\Microsoft\\Windows\\CurrentVersion\\Run &gt;&gt;qidong.txt</span></span>
<span class="line"><span>reg query HKLM\\SOFTWARE\\WOW6432Node\\Microsoft\\Windows\\CurrentVersion\\RunOnce &gt;&gt;qidong.txt</span></span>
<span class="line"><span>reg query HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\Explorer\\run &gt;&gt;qidong.txt</span></span>
<span class="line"><span>reg query HKLM\\Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\Explorer\\run &gt;&gt;qidong.txt</span></span>
<span class="line"><span>reg query HKLM\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Explorer\\StartMenu &gt;&gt;qidong.txt</span></span>
<span class="line"><span>reg query &quot;HKCU\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Windows&quot; /v Load &gt;&gt;qidong.txt</span></span>
<span class="line"><span>@echo.</span></span>
<span class="line"><span>call:colorys 0A &quot;[+] 检查网络连接（ipc$ 命名管道连接），并写入文件：&quot;</span></span>
<span class="line"><span>@echo.</span></span>
<span class="line"><span>net use</span></span>
<span class="line"><span>wmic netuse get ConnectionState,Description,DisplayType,LocalName,Name,Persistent,RemoteName,ResourceType,Status,UserName /format:&quot;%var%&quot; &gt;&gt; out.html</span></span>
<span class="line"><span>call:colorys 0A &quot;[+] 检查是否启用Windows剪切板历史记录：(0x1代表启用，适用Win10）：&quot;</span></span>
<span class="line"><span>@echo.</span></span>
<span class="line"><span>reg query HKEY_CURRENT_USER\\Software\\Microsoft\\Clipboard /v EnableClipboardHistory</span></span>
<span class="line"><span>@echo.</span></span>
<span class="line"><span>call:colorys 0A &quot;[+] 检查用户登录初始化、管理员自动登录：&quot;</span></span>
<span class="line"><span>reg query &quot;HKLM\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Winlogon&quot; /v Userinit</span></span>
<span class="line"><span>reg query &quot;HKLM\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Winlogon&quot; /v AutoAdminLogon</span></span>
<span class="line"><span>call:colorys 0A &quot;[+] 检查Logon Scripts:&quot;</span></span>
<span class="line"><span>reg query HKCU\\Environment /v UserInitMprLogonScript</span></span>
<span class="line"><span>@echo.</span></span>
<span class="line"><span>call:colorys 0A &quot;[+] 检查屏幕保护程序：&quot;</span></span>
<span class="line"><span>reg query &quot;HKCU\\Control Panel\\Desktop&quot; /v SCRNSAVE.EXE</span></span>
<span class="line"><span>@echo.</span></span>
<span class="line"><span>call:colorys 0A &quot;[+] 检查AppInit_DLLs：&quot;</span></span>
<span class="line"><span>reg query &quot;HKLM\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Windows&quot; /v AppInit_DLLs</span></span>
<span class="line"><span>reg query &quot;HKLM\\SOFTWARE\\Wow6432Node\\Microsoft\\Windows NT\\CurrentVersion\\Windows&quot; /v AppInit_DLLs</span></span>
<span class="line"><span>call:colorys 0A &quot;[+] 检查COM劫持，并写入文件：&quot;</span></span>
<span class="line"><span>::通过修改注册表键值，使特定的clsid指向恶意的dll，程序运行时就会加载恶意的dll</span></span>
<span class="line"><span>reg query HKCU\\Software\\Classes\\CLSID /s /t REG_SZ &gt; 32os_32pe_and_64os_64pe.txt</span></span>
<span class="line"><span>reg query HKCU\\Software\\Classes\\Wow6432Node\\CLSID /s /t REG_SZ &gt; x86OS_x64pe.txt</span></span>
<span class="line"><span>@echo.</span></span>
<span class="line"><span>call:colorys 0A &quot;[+] 检查shim数据库是否被劫持：&quot;</span></span>
<span class="line"><span>@echo.</span></span>
<span class="line"><span>::主要解决应用兼容性问题的解决方法，执行被劫持的程序时自动加载数据库中恶意模块（dll，shellcode等）</span></span>
<span class="line"><span>reg query &quot;HKLM\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\AppCompatFlags\\Custom&quot;</span></span>
<span class="line"><span>reg query &quot;HKLM\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\AppCompatFlags\\InstalledSDB&quot; /s</span></span>
<span class="line"><span>dir /a /b C:\\Windows\\AppPatch\\Custom</span></span>
<span class="line"><span>dir /a /b C:\\Windows\\AppPatch\\Custom\\Custom64</span></span>
<span class="line"><span>@echo.</span></span>
<span class="line"><span>call:colorys 0A &quot;[+] 检查进程注入：&quot;</span></span>
<span class="line"><span>@echo.</span></span>
<span class="line"><span>reg query &quot;HKLM\\System\\CurrentControlSet\\Control\\Session Manager\\AppCertDlls&quot;</span></span>
<span class="line"><span>@echo.</span></span>
<span class="line"><span>call:colorys 0A &quot;[+] 检查exe文件启动相关注册表：&quot;</span></span>
<span class="line"><span>reg query HKLM\\software\\classes\\exefile\\shell\\open\\command</span></span>
<span class="line"><span>call:colorys 0A &quot;[+] 检查Lsa，用于hash传递攻击：&quot;</span></span>
<span class="line"><span>reg query HKLM\\System\\CurrentControlSet\\Control\\Lsa /v DisableRestrictedAdmin</span></span>
<span class="line"><span>call:colorys 0A &quot;[+] 检查映像劫持：&quot;</span></span>
<span class="line"><span>rem 适用于windows 2008/win7</span></span>
<span class="line"><span>reg query &quot;HKLM\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Image File Execution Options&quot; -s -f &quot;.exe&quot; -v Debugger</span></span>
<span class="line"><span>reg query &quot;HKLM\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Image File Execution Options&quot; /s /f &quot;.exe&quot; /v GlobalFlag</span></span>
<span class="line"><span>reg query &quot;HKLM\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\SilentProcessExit&quot;</span></span>
<span class="line"><span>@echo.</span></span>
<span class="line"><span>call:colorys 0A &quot;[+] 查询接受最终用户许可协议的程序：&quot;</span></span>
<span class="line"><span>reg query HKCU\\Software\\SysInternals</span></span>
<span class="line"><span>@echo.</span></span>
<span class="line"><span>call:colorys 0A &quot;[+] 查询安全模式启动相关注册表：&quot;</span></span>
<span class="line"><span>@echo.</span></span>
<span class="line"><span>reg query HKLM\\SYSTEM\\CurrentControlSet\\Control\\SafeBoot /v AlternateShell</span></span>
<span class="line"><span>call:colorys 0A &quot;[+] 查询powershell命令记录，拷贝中：&quot;</span></span>
<span class="line"><span>@echo.</span></span>
<span class="line"><span>::适用于powershell高版本</span></span>
<span class="line"><span>if exist %appdata%\\Microsoft\\Windows\\PowerShell\\PSReadline\\ConsoleHost_history.txt type %appdata%\\Microsoft\\Windows\\PowerShell\\PSReadline\\ConsoleHost_history.txt</span></span>
<span class="line"><span>copy /Y C:\\Windows\\System32\\winevt\\Logs\\Microsoft-Windows-PowerShell%%4Operational.evtx .\\eventlog\\</span></span>
<span class="line"><span>@echo.</span></span>
<span class="line"><span>call:colorys 0A &quot;[+] 检查IE浏览器记录：&quot;</span></span>
<span class="line"><span>reg query &quot;HKCU\\SOFTWARE\\Microsoft\\Internet Explorer\\TypedURLs&quot;</span></span>
<span class="line"><span>call:colorys 0A &quot;[+] 检查CryptnetURLCache，查看certutil下载记录：&quot;</span></span>
<span class="line"><span>::利用工具：CryptnetURLCacheParser</span></span>
<span class="line"><span>@echo.</span></span>
<span class="line"><span>if exist C:\\Windows\\System32\\config\\systemprofile\\AppData\\LocalLow\\Microsoft\\CryptnetUrlCache (xcopy /s /q /h /o /y C:\\Windows\\System32\\config\\systemprofile\\AppData\\LocalLow\\Microsoft\\CryptnetUrlCache .\\CryptnetUrlCache\\)</span></span>
<span class="line"><span>if exist C:\\Windows\\SysWOW64\\config\\systemprofile\\AppData\\LocalLow\\Microsoft\\CryptnetUrlCache (xcopy /s /q /h /o /y C:\\Windows\\SysWOW64\\config\\systemprofile\\AppData\\LocalLow\\Microsoft\\CryptnetUrlCache .\\CryptnetUrlCache\\)</span></span>
<span class="line"><span>if exist %USERPROFILE%\\AppData\\LocalLow\\Microsoft\\CryptnetUrlCache (xcopy /s /q /h /o /y %USERPROFILE%\\AppData\\LocalLow\\Microsoft\\CryptnetUrlCache .\\CryptnetUrlCache\\ )</span></span>
<span class="line"><span>@echo.</span></span>
<span class="line"><span>call:colorys 0A &quot;[+] 检查最近访问的文件，写入文件中：&quot;</span></span>
<span class="line"><span>@echo.</span></span>
<span class="line"><span>dir /a %AppData%\\Microsoft\\Windows\\Recent &gt; Recent.txt</span></span>
<span class="line"><span>if exist &quot;%SYSTEMROOT%\\Documents and Settings\\%USERPROFILE%\\Recent\\&quot; (dir /a %SYSTEMROOT%\\Documents and Settings\\%USERPROFILE%\\Recent\\ &gt;&gt;Recent.txt)</span></span>
<span class="line"><span>dir /a %USERPROFILE%\\AppData\\Roaming\\Microsoft\\Office\\Recent\\ &gt;&gt;Recent.txt</span></span>
<span class="line"><span>@echo.</span></span>
<span class="line"><span>call:colorys 0A &quot;[+] 检查&quot;我的电脑、此电脑、计算机&quot;的任意文件夹地址栏内的历史记录：&quot;</span></span>
<span class="line"><span>reg query HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Explorer\\TypedPaths</span></span>
<span class="line"><span>call:colorys 0A &quot;[+] 检查【运行】的历史记录：&quot;</span></span>
<span class="line"><span>reg query HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Explorer\\RunMRU</span></span>
<span class="line"><span>call:colorys 0A &quot;[+] 检查网络连接情况，并写入文件：&quot;</span></span>
<span class="line"><span>@echo.</span></span>
<span class="line"><span>netstat -anob | findstr ESTABLISHED</span></span>
<span class="line"><span>::适用于Win10，Win7不适用</span></span>
<span class="line"><span>powershell $aa=&quot;Get-NetTCPConnection | select LocalAddress,localport,remoteaddress,remoteport,state,@{name=\\&quot;process\\&quot;;Expression={(get-process -id $_.OwningProcess).ProcessName}}, @{Name=\\&quot;cmdline\\&quot;;Expression={(Get-WmiObject Win32_Process -filter \\&quot;ProcessId = $($_.OwningProcess)\\&quot;).commandline}} |  sort Remoteaddress -Descending | ft -wrap -autosize &gt; network_tcp.txt&quot;;$aa</span></span>
<span class="line"><span>@echo.</span></span>
<span class="line"><span>call:colorys 0A &quot;[+] 检查DNS缓存记录，并写入文件中：&quot;</span></span>
<span class="line"><span>::适用win10，win7不适用</span></span>
<span class="line"><span>@echo.</span></span>
<span class="line"><span>powershell $aa=&quot;Get-DnsClientCache |ft -wrap -autosize&quot;;$aa</span></span>
<span class="line"><span>ipconfig /displaydns &gt; dns_cache.txt</span></span>
<span class="line"><span>call:colorys 0A &quot;[+] 检查进程，写入文件中：&quot;</span></span>
<span class="line"><span>wmic process get name,ParentProcessId,processid,executablepath,CreationDate,commandline /format:&quot;%var%&quot; &gt;&gt; out.html</span></span>
<span class="line"><span>wmic process get name,parentprocessid,processid,executablepath,CreationDate,commandline /format:csv &gt; process.csv</span></span>
<span class="line"><span>powershell $aa=&quot;gwmi win32_process | Select Name, ProcessID, @{n=&#39;Owner&#39;;e={$_.GetOwner().User}},CommandLine | ft -wrap -autosize &gt; process_ps.txt&quot;;$aa</span></span>
<span class="line"><span>@echo.</span></span>
<span class="line"><span>call:colorys 0A &quot;[+] 调查取证——导出SAM、SECURITY、SYSTEM（记录系统运行的可执行文件的完整路径和最后的执行日期）：&quot;</span></span>
<span class="line"><span>::可用Registry Explorer对SYSTEM文件进行分析，AppCompatCache记录程序的修改时间，一定程度上可以确定程序的最迟运行时间</span></span>
<span class="line"><span>@echo.</span></span>
<span class="line"><span>reg save hklm\\system .\\hive\\SYSTEM /Y</span></span>
<span class="line"><span>reg save hklm\\sam .\\hive\\SAM /Y</span></span>
<span class="line"><span>reg save hklm\\security .\\hive\\SECURITY /Y</span></span>
<span class="line"><span>call:colorys 0A &quot;[+] 调查取证——收集 Sysmon 日志：&quot;</span></span>
<span class="line"><span>if exist C:\\Windows\\System32\\winevt\\Logs\\Microsoft-Windows-Sysmon%%4Operational.evtx (copy /Y &quot;C:\\Windows\\System32\\winevt\\Logs\\Microsoft-Windows-Sysmon%%4Operational.evtx&quot; .\\eventlog\\)</span></span>
<span class="line"><span>call:colorys 0A &quot;[+] 调查取证——检查BAM（记录系统运行的可执行文件的完整路径和最后的执行日期，适用于Win10），写入文件中：&quot;</span></span>
<span class="line"><span>@echo.</span></span>
<span class="line"><span>reg query &quot;HKLM\\SYSTEM\\CurrentControlSet\\Services\\bam\\state\\UserSettings&quot; /s &gt; BAM.txt</span></span>
<span class="line"><span>call:colorys 0A &quot;[+] 调查取证——SRUM (System Resource Usage Monitor)，拷贝中：&quot;</span></span>
<span class="line"><span>if exist C:\\Windows\\System32\\sru\\SRUDB.dat (copy /Y C:\\Windows\\System32\\sru\\SRUDB.dat)</span></span>
<span class="line"><span>@echo.</span></span>
<span class="line"><span>call:colorys 0A &quot;[+] 调查取证——MUICache (从exe文件的版本资源中提取应用程序名、公司名)，写入文件中：&quot;</span></span>
<span class="line"><span>reg query &quot;HKCU\\Software\\Classes\\Local Settings\\Software\\Microsoft\\Windows\\Shell\\MuiCache&quot; &gt; MuiCache.txt</span></span>
<span class="line"><span>@echo.</span></span>
<span class="line"><span>call:colorys 0A &quot;[+] 调查取证——ShimCache (跟踪文件路径、上次修改时间和是否被执行)，注册表导出中：&quot;</span></span>
<span class="line"><span>@echo.</span></span>
<span class="line"><span>reg export &quot;HKLM\\SYSTEM\\CurrentControlSet\\Control\\Session Manager\\AppCompatCache&quot; ShimCache.reg /Y</span></span>
<span class="line"><span>call:colorys 0A &quot;[+] 调查取证——Prefetch (会保存文件第一次和最后一次运行日期、路径和执行次数等信息)，拷贝中&quot;</span></span>
<span class="line"><span>@echo.</span></span>
<span class="line"><span>::for %%i in (C:\\Windows\\Prefetch\\*) do copy /Y %%i Prefetch\\</span></span>
<span class="line"><span>xcopy /s /q /h /o /y C:\\Windows\\Prefetch .\\Prefetch\\</span></span>
<span class="line"><span>call:colorys 0A &quot;[+] 检查系统日志是否有开启：&quot;</span></span>
<span class="line"><span>reg query HKLM\\SYSTEM\\CurrentControlSet\\services\\eventlog</span></span>
<span class="line"><span>call:colorys 0A &quot;[+] 正在导出系统日志：&quot;</span></span>
<span class="line"><span>if exist .\\eventlog\\system.evtx (del .\\eventlog\\system.evtx)</span></span>
<span class="line"><span>wevtutil epl System .\\eventlog\\system.evtx</span></span>
<span class="line"><span>if exist .\\eventlog\\Application.evtx (del .\\eventlog\\Application.evtx)</span></span>
<span class="line"><span>wevtutil epl Application .\\eventlog\\Application.evtx</span></span>
<span class="line"><span>if exist .\\eventlog\\Security.evtx (del .\\eventlog\\Security.evtx)</span></span>
<span class="line"><span>wevtutil epl Security .\\eventlog\\Security.evtx</span></span>
<span class="line"><span>rem 远程桌面日志，筛选1149</span></span>
<span class="line"><span>if exist .\\eventlog\\TerminalServices.evtx (del .\\eventlog\\TerminalServices.evtx)</span></span>
<span class="line"><span>wevtutil epl Microsoft-Windows-TerminalServices-RemoteConnectionManager/Operational .\\eventlog\\TerminalServices.evtx</span></span>
<span class="line"><span>@echo.</span></span>
<span class="line"><span>pause</span></span>
<span class="line"><span>::把以下代码放到批处理底部用call调用</span></span>
<span class="line"><span>:colorys</span></span>
<span class="line"><span>pushd %tmp%&amp;echo CCAICCAI&gt;%2-&amp;certutil /f /decode %2- %2- 1&gt;nul 2&gt;nul</span></span>
<span class="line"><span>findstr /a:%1 . %2- \\ 2&gt;nul&amp;del /q /f %2- 1&gt;nul 2&gt;nul&amp;popd&amp;exit /b</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,11)])])}const r=n(l,[["render",p]]),d=JSON.parse('{"path":"/sec/rednote/onekey/winscan.html","title":"一键Windows应急响应检测脚本","lang":"zh-CN","frontmatter":{"date":"2022-04-03T00:00:00.000Z","title":"一键Windows应急响应检测脚本","author":["SecCMD"],"description":"一键Windows应急响应检测脚本\\n","categories":"安全工具","tags":["应急响应","Winscan"],"head":[["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"一键Windows应急响应检测脚本\\",\\"image\\":[\\"\\"],\\"datePublished\\":\\"2022-04-03T00:00:00.000Z\\",\\"dateModified\\":\\"2025-09-09T09:34:45.000Z\\",\\"author\\":[{\\"@type\\":\\"Person\\",\\"name\\":\\"SecCMD\\"}]}"],["meta",{"property":"og:url","content":"https://vuepress-theme-hope-docs-demo.netlify.app/sec/rednote/onekey/winscan.html"}],["meta",{"property":"og:site_name","content":"明剑安全"}],["meta",{"property":"og:title","content":"一键Windows应急响应检测脚本"}],["meta",{"property":"og:description","content":"一键Windows应急响应检测脚本\\n"}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:locale","content":"zh-CN"}],["meta",{"property":"og:updated_time","content":"2025-09-09T09:34:45.000Z"}],["meta",{"property":"article:author","content":"SecCMD"}],["meta",{"property":"article:tag","content":"Winscan"}],["meta",{"property":"article:tag","content":"应急响应"}],["meta",{"property":"article:published_time","content":"2022-04-03T00:00:00.000Z"}],["meta",{"property":"article:modified_time","content":"2025-09-09T09:34:45.000Z"}]]},"git":{"createdTime":1734092873000,"updatedTime":1757410485000,"contributors":[{"name":"seccmd","username":"seccmd","email":"79789833+seccmd@users.noreply.github.com","commits":2,"url":"https://github.com/seccmd"},{"name":"fireadm","username":"fireadm","email":"iwanwu@hotmail.com","commits":1,"url":"https://github.com/fireadm"}]},"readingTime":{"minutes":9.64,"words":2891},"filePathRelative":"sec/rednote/onekey/winscan.md"}');export{r as comp,d as data};
