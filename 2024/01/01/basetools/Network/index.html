<!DOCTYPE html>
<html lang='zh-CN'>

<head>
  <meta name="generator" content="Hexo 6.3.0">
  <meta name="hexo-theme" content="https://github.com/xaoxuu/hexo-theme-stellar/tree/1.19.0">
  <meta charset="utf-8">
  

  <meta http-equiv='x-dns-prefetch-control' content='on' />
  <link rel='dns-prefetch' href='https://gcore.jsdelivr.net'>
  <link rel="preconnect" href="https://gcore.jsdelivr.net" crossorigin>
  <link rel='dns-prefetch' href='//unpkg.com'>

  <meta name="renderer" content="webkit">
  <meta name="force-rendering" content="webkit">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
  <meta name="HandheldFriendly" content="True" >
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="theme-color" content="#f8f8f8">
  
  <title>网络配置与调试全攻略 | OpenConnect、Clash及网络工具使用指南 - 数字安全极客</title>

  
    <meta name="description" content="本页面专注于网络相关知识，涵盖OpenConnect VPN Server的安装与配置，包括系统网络转发配置、服务端配置和高级路由配置；Clash透明代理技术在本机安装、Tun模式及DNS分流的详细设置，以及DNS精准分流的高级配置；Anyconnect客户端的使用，包括命令行连接与自动登录脚本；网络调试方面，介绍了Network Tools、Tcpdump、Route、Iptables等工具的基">
<meta property="og:type" content="article">
<meta property="og:title" content="网络配置与调试全攻略 | OpenConnect、Clash及网络工具使用指南">
<meta property="og:url" content="http://example.com/2024/01/01/basetools/Network/index.html">
<meta property="og:site_name" content="数字安全极客">
<meta property="og:description" content="本页面专注于网络相关知识，涵盖OpenConnect VPN Server的安装与配置，包括系统网络转发配置、服务端配置和高级路由配置；Clash透明代理技术在本机安装、Tun模式及DNS分流的详细设置，以及DNS精准分流的高级配置；Anyconnect客户端的使用，包括命令行连接与自动登录脚本；网络调试方面，介绍了Network Tools、Tcpdump、Route、Iptables等工具的基">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2024-01-01T00:00:00.000Z">
<meta property="article:modified_time" content="2025-01-22T14:15:53.085Z">
<meta property="article:author" content="SecAdmin">
<meta property="article:tag" content="VPN配置">
<meta property="article:tag" content="透明代理">
<meta property="article:tag" content="网络调试工具">
<meta name="twitter:card" content="summary">
  
  
  
  <meta name="keywords" content="VPN配置,透明代理,网络调试工具">

  <!-- feed -->
  

  
    
<link rel="stylesheet" href="/css/main.css">

  

  
    <link rel="shortcut icon" href="/assets/logo.ico">
  

  

  


  
    
      <link rel="preconnect" href="https://gcore.jsdelivr.net">
    
      <link rel="stylesheet" href="https://gcore.jsdelivr.net/npm/lxgw-wenkai-screen-webfont@1.1.0/lxgwwenkaiscreen.css" media="all">
    
      <script>var _hmt = _hmt || [];(function() {  var hm = document.createElement("script");  hm.src = "https://hm.baidu.com/hm.js?471fac1b9a27585ef00b1647ef02618e";  var s = document.getElementsByTagName("script")[0];   s.parentNode.insertBefore(hm, s);})();</script>
    
      <!-- Google tag (gtag.js) --><script async src="https://www.googletagmanager.com/gtag/js?id=G-3CKX8MZFEY"></script><script>  window.dataLayer = window.dataLayer || [];  function gtag(){dataLayer.push(arguments);}  gtag('js', new Date());  gtag('config', 'G-3CKX8MZFEY');</script>
    
      <!-- Google ADS google.com/adsense/ --><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-9718108884365672" crossorigin="anonymous"></script>
    
  
</head>

<body>
  




  <div class='l_body' id='start'>
    <aside class='l_left' layout='post'>
    

  

<header class="header"><div class="logo-wrap"><a class="avatar" href="/about/"><div class="bg" style="opacity:0;background-image:url(https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.4/avatar/round/rainbow64@3x.webp);"></div><img no-lazy class="avatar" src="/assets/logo.png" onerror="javascript:this.classList.add('error');this.src='https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.4/image/2659360.svg';"></a><a class="title" href="/"><div class="main" ff="title">数字安全极客</div><div class="sub normal cap">专注实战安全防御体系</div><div class="sub hover cap" style="opacity:0"> Digital Security Geek</div></a></div>

<nav class="menu dis-select"></nav>
</header>


<div class="widgets">
<widget class="widget-wrapper search"><div class="widget-body"><div class="search-wrapper" id="search"><form class="search-form"><input type="text" class="search-input" id="search-input" data-filter="/blog/" placeholder="文章搜索"><svg t="1670596976048" class="icon search-icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="2676" width="200" height="200"><path d="M938.2 832.6L723.8 618.1c-2.5-2.5-5.3-4.4-7.9-6.4 36.2-55.6 57.3-121.8 57.3-193.1C773.3 222.8 614.6 64 418.7 64S64 222.8 64 418.6c0 195.9 158.8 354.6 354.6 354.6 71.3 0 137.5-21.2 193.2-57.4 2 2.7 3.9 5.4 6.3 7.8L832.5 938c14.6 14.6 33.7 21.9 52.8 21.9 19.1 0 38.2-7.3 52.8-21.8 29.2-29.1 29.2-76.4 0.1-105.5M418.7 661.3C284.9 661.3 176 552.4 176 418.6 176 284.9 284.9 176 418.7 176c133.8 0 242.6 108.9 242.6 242.7 0 133.7-108.9 242.6-242.6 242.6" p-id="2677"></path></svg></form><div id="search-result"></div><div class="search-no-result">没有找到内容！</div></div></div></widget>


<widget class="widget-wrapper toc single" id="data-toc"><div class="widget-header cap dis-select"><span class="name">网络配置与调试全攻略 | OpenConnect、Clash及网络工具使用指南</span></div><div class="widget-body fs14"><div class="doc-tree active"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83"><span class="toc-text">参考</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%89%E8%A3%85-OpenConnect-VPN-Server"><span class="toc-text">安装 OpenConnect VPN Server</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%B3%BB%E7%BB%9F%E7%BD%91%E7%BB%9C%E8%BD%AC%E5%8F%91%E9%85%8D%E7%BD%AE"><span class="toc-text">系统网络转发配置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE-%E9%AB%98%E7%BA%A7%E8%B7%AF%E7%94%B1"><span class="toc-text">配置 高级路由</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%F0%9F%8D%8E-x3D-x3D-x3D-x3D-%E9%80%8F%E6%98%8E%E4%BB%A3%E7%90%86-x3D-x3D-x3D-x3D"><span class="toc-text">🍎&#x3D;&#x3D;&#x3D;&#x3D;透明代理&#x3D;&#x3D;&#x3D;&#x3D;</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Clash-%E9%80%8F%E6%98%8E%E4%BB%A3%E7%90%86%E6%8A%80%E6%9C%AF-%E6%9C%AC%E6%9C%BA%E5%AE%89%E8%A3%85"><span class="toc-text">Clash 透明代理技术 - 本机安装</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Clash-%E9%80%8F%E6%98%8E%E4%BB%A3%E7%90%86%E6%8A%80%E6%9C%AF-Tun-%E6%A8%A1%E5%BC%8F"><span class="toc-text">Clash 透明代理技术 - Tun 模式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Clash-%E9%80%8F%E6%98%8E%E4%BB%A3%E7%90%86%E6%8A%80%E6%9C%AF-DNS-%E5%88%86%E6%B5%81"><span class="toc-text">Clash 透明代理技术 - DNS 分流</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#DNS-%E7%B2%BE%E5%87%86%E5%88%86%E6%B5%81-%E9%AB%98%E7%BA%A7%E9%85%8D%E7%BD%AE"><span class="toc-text">DNS 精准分流 - 高级配置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Anyconnect-%E5%AE%A2%E6%88%B7%E7%AB%AF"><span class="toc-text">Anyconnect  客户端</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Anyconnect-%E5%91%BD%E4%BB%A4%E8%A1%8C%E4%BD%BF%E7%94%A8"><span class="toc-text">Anyconnect  命令行使用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%F0%9F%8D%8E-x3D-x3D-x3D-x3D-%E7%BD%91%E7%BB%9C%E8%B0%83%E8%AF%95-x3D-x3D-x3D-x3D"><span class="toc-text">🍎&#x3D;&#x3D;&#x3D;&#x3D;网络调试&#x3D;&#x3D;&#x3D;&#x3D;</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Network-Tools"><span class="toc-text">Network Tools</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Tcpdump-%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8"><span class="toc-text">Tcpdump 基本使用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Route-%E5%9F%BA%E7%A1%80%E6%93%8D%E4%BD%9C"><span class="toc-text">Route 基础操作</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Iptables-%E7%A4%BA%E6%84%8F%E5%9B%BE"><span class="toc-text">Iptables 示意图</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Iptables-Debug"><span class="toc-text">Iptables Debug</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Iptables-tproxy-%E9%80%8F%E6%98%8E%E4%BB%A3%E7%90%86%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86"><span class="toc-text">Iptables tproxy 透明代理技术原理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AB%AF%E5%8F%A3%E5%A4%8D%E7%94%A8"><span class="toc-text">端口复用</span></a></li></ol></li></ol></div></div></widget>




</div>
<footer class="footer dis-select"><div class="social-wrap"><a class="social" href="/" rel="noopener noreferrer"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-house-fill" viewBox="0 0 16 16"><path d="M8.707 1.5a1 1 0 0 0-1.414 0L.646 8.146a.5.5 0 0 0 .708.708L8 2.207l6.646 6.647a.5.5 0 0 0 .708-.708L13 5.793V2.5a.5.5 0 0 0-.5-.5h-1a.5.5 0 0 0-.5.5v1.293L8.707 1.5Z"/> <path d="m8 3.293 6 6V13.5a1.5 1.5 0 0 1-1.5 1.5h-9A1.5 1.5 0 0 1 2 13.5V9.293l6-6Z"/></svg></a><a class="social" href="https://github.com/seccmd" target="_blank" rel="external nofollow noopener noreferrer"><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://cdn.jsdelivr.net/gh/cdn-x/placeholder@1.0.1/social/08a41b181ce68.svg"/></a><a class="social" href="https://twitter.com/sec_cmd" target="_blank" rel="external nofollow noopener noreferrer"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-twitter" viewBox="0 0 16 16">  <path d="M5.026 15c6.038 0 9.341-5.003 9.341-9.334 0-.14 0-.282-.006-.422A6.685 6.685 0 0 0 16 3.542a6.658 6.658 0 0 1-1.889.518 3.301 3.301 0 0 0 1.447-1.817 6.533 6.533 0 0 1-2.087.793A3.286 3.286 0 0 0 7.875 6.03a9.325 9.325 0 0 1-6.767-3.429 3.289 3.289 0 0 0 1.018 4.382A3.323 3.323 0 0 1 .64 6.575v.045a3.288 3.288 0 0 0 2.632 3.218 3.203 3.203 0 0 1-.865.115 3.23 3.23 0 0 1-.614-.057 3.283 3.283 0 0 0 3.067 2.277A6.588 6.588 0 0 1 .78 13.58a6.32 6.32 0 0 1-.78-.045A9.344 9.344 0 0 0 5.026 15z"/></svg></a><a class="social" href="https://123.seccmd.net" target="_blank" rel="external nofollow noopener noreferrer"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-tools" viewBox="0 0 16 16"><path d="M1 0 0 1l2.2 3.081a1 1 0 0 0 .815.419h.07a1 1 0 0 1 .708.293l2.675 2.675-2.617 2.654A3.003 3.003 0 0 0 0 13a3 3 0 1 0 5.878-.851l2.654-2.617.968.968-.305.914a1 1 0 0 0 .242 1.023l3.27 3.27a.997.997 0 0 0 1.414 0l1.586-1.586a.997.997 0 0 0 0-1.414l-3.27-3.27a1 1 0 0 0-1.023-.242L10.5 9.5l-.96-.96 2.68-2.643A3.005 3.005 0 0 0 16 3c0-.269-.035-.53-.102-.777l-2.14 2.141L12 4l-.364-1.757L13.777.102a3 3 0 0 0-3.675 3.68L7.462 6.46 4.793 3.793a1 1 0 0 1-.293-.707v-.071a1 1 0 0 0-.419-.814L1 0Zm9.646 10.646a.5.5 0 0 1 .708 0l2.914 2.915a.5.5 0 0 1-.707.707l-2.915-2.914a.5.5 0 0 1 0-.708ZM3 11l.471.242.529.026.287.445.445.287.026.529L5 13l-.242.471-.026.529-.445.287-.287.445-.529.026L3 15l-.471-.242L2 14.732l-.287-.445L1.268 14l-.026-.529L1 13l.242-.471.026-.529.445-.287.287-.445.529-.026L3 11Z"/></svg></a></div></footer>

    </aside>
    <div class='l_main'>
      

      



<div class="bread-nav fs12"><div id="breadcrumb"><a class="cap breadcrumb" href="/">主页</a><span class="sep"></span><a class="cap breadcrumb" href="/">文章</a><span class="sep"></span><a class="cap breadcrumb-link" href="/categories/%E7%BD%91%E7%BB%9C%E5%B7%A5%E5%85%B7/">网络工具</a></div><div id="post-meta">发布于&nbsp;<time datetime="2024-01-01T00:00:00.000Z">2024-01-01</time></div></div>

<article class='md-text content post'>
<h1 class="article-title"><span>网络配置与调试全攻略 | OpenConnect、Clash及网络工具使用指南</span></h1>
<h1 id="Network"><a href="#Network" class="headerlink" title="Network"></a>Network</h1><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a target="_blank" rel="noopener" href="https://www.linuxbabe.com/ubuntu/openconnect-vpn-server-ocserv-ubuntu-20-04-lets-encrypt">https://www.linuxbabe.com/ubuntu/openconnect-vpn-server-ocserv-ubuntu-20-04-lets-encrypt</a><br><a target="_blank" rel="noopener" href="https://www.vultr.com/docs/setup-openconnect-vpn-server-for-cisco-anyconnect-on-ubuntu-14-04-x64/">https://www.vultr.com/docs/setup-openconnect-vpn-server-for-cisco-anyconnect-on-ubuntu-14-04-x64/</a></p>
<p>踩了一个坑 ubuntu22 客户端连接服务端 报错， 用 ubuntu 20 正常。</p>
<h2 id="安装-OpenConnect-VPN-Server"><a href="#安装-OpenConnect-VPN-Server" class="headerlink" title="安装 OpenConnect VPN Server"></a>安装 OpenConnect VPN Server</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 很全面的文章，安装客户端、服务端和免费证书 - https://www.linuxbabe.com/ubuntu/openconnect-vpn-server-ocserv-ubuntu-20-04-lets-encrypt</span></span><br><span class="line"><span class="built_in">sudo</span> apt update</span><br><span class="line"><span class="built_in">sudo</span> apt install ocserv</span><br><span class="line"><span class="built_in">sudo</span> systemctl status ocserv</span><br><span class="line"><span class="built_in">sudo</span> systemctl start ocserv</span><br></pre></td></tr></table></figure>

<h2 id="系统网络转发配置"><a href="#系统网络转发配置" class="headerlink" title="系统网络转发配置"></a>系统网络转发配置</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line">iptables -t nat -A POSTROUTING -j MASQUERADE     <span class="comment">## Enable NAT.</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;net.ipv4.ip_forward=1&quot;</span> &gt;&gt; /etc/sysctl.conf <span class="comment">## Enable IPv4 forwarding. Edit the file /etc/sysctl.conf.</span></span><br><span class="line">sysctl -p /etc/sysctl.conf                       <span class="comment">## Apply this modification.</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;nameserver 8.8.8.8&#x27;</span> &gt; /etc/resolv.conf     <span class="comment">## 临时修改 DNS 配置</span></span><br><span class="line"><span class="comment">## 永久修改 DNS 配置</span></span><br><span class="line"><span class="built_in">sudo</span> apt-get install resolvconf</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;nameserver 8.8.8.8&#x27;</span> &gt;&gt; /etc/resolvconf/resolv.conf.d/head</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;nameserver 1.1.1.1&#x27;</span> &gt;&gt; /etc/resolvconf/resolv.conf.d/head</span><br><span class="line"><span class="built_in">sudo</span> systemctl <span class="built_in">enable</span> --now resolvconf.service</span><br><span class="line">````</span><br><span class="line"></span><br><span class="line"><span class="comment">## 配置 服务端</span></span><br><span class="line">``` bash</span><br><span class="line">vi /etc/ocserv/ocserv.conf</span><br><span class="line"></span><br><span class="line"><span class="comment">## 监听端口</span></span><br><span class="line">tcp-port = 1443</span><br><span class="line">udp-port = 1443</span><br><span class="line"></span><br><span class="line"><span class="comment">## DNS 配置</span></span><br><span class="line">tunnel-all-dns = <span class="literal">true</span></span><br><span class="line">dns = 8.8.8.8</span><br><span class="line"></span><br><span class="line"><span class="comment">## VPN 账号</span></span><br><span class="line">auth = <span class="string">&quot;pam[gid-min=1000]&quot;</span>  <span class="comment"># 直接使用 Linux 系统账号</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## ocserv 重启服务</span></span><br><span class="line"><span class="built_in">sudo</span> systemctl restart ocserv</span><br><span class="line"><span class="built_in">sudo</span> systemctl restart ocserv.socket</span><br><span class="line"></span><br><span class="line"><span class="comment">## ！监听端口故障，修改 ocserv.conf 监听断开配置无效，同时需要修改系统服务配置 ocserv.socket</span></span><br><span class="line"><span class="comment">## ocserv 系统服务文件</span></span><br><span class="line"><span class="built_in">cat</span> /lib/systemd/system/ocserv.socket</span><br><span class="line">[Unit]</span><br><span class="line">Description=OpenConnect SSL VPN server Socket</span><br><span class="line">[Socket]</span><br><span class="line">ListenStream=443</span><br><span class="line">ListenDatagram=443</span><br><span class="line">BindIPv6Only=default</span><br><span class="line">Accept=<span class="literal">false</span></span><br><span class="line">ReusePort=<span class="literal">true</span></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=sockets.target</span><br></pre></td></tr></table></figure>



<h2 id="配置-高级路由"><a href="#配置-高级路由" class="headerlink" title="配置 高级路由"></a>配置 高级路由</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 高级配置</span></span><br><span class="line">- https://www.linuxbabe.com/linux-server/ocserv-openconnect-vpn-advanced</span><br><span class="line"></span><br><span class="line"><span class="comment">## 给特定用户和用户组，配置定制的路由策略</span></span><br><span class="line"><span class="comment">### 新建用户 vpnuser</span></span><br><span class="line">useradd vpnuser</span><br><span class="line">passwd vpnuser</span><br><span class="line"></span><br><span class="line"><span class="comment">### /etc/ocserv/ocserv.conf 主配置文件添加，独立配置目录 </span></span><br><span class="line">config-per-user = /etc/ocserv/config-per-user/</span><br><span class="line">config-per-group = /etc/ocserv/config-per-group/</span><br><span class="line"></span><br><span class="line"><span class="comment">### 给特定用户或用户组，创建独立配置文件</span></span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">mkdir</span> /etc/ocserv/config-per-user/</span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">mkdir</span> /etc/ocserv/config-per-group/</span><br><span class="line"><span class="built_in">sudo</span> vi /etc/ocserv/config-per-user/user1</span><br><span class="line"><span class="built_in">sudo</span> vi /etc/ocserv/config-per-group/group1</span><br><span class="line"><span class="comment"># 例如：我刚才创建的用户名为：vpnuser</span></span><br><span class="line"><span class="built_in">sudo</span> vi /etc/ocserv/config-per-user/vpnuser</span><br><span class="line"></span><br><span class="line"><span class="comment">## 配置内网的路由地址池 Secured Routes (IPv4)</span></span><br><span class="line">route = 10.16.0.0/13</span><br><span class="line"></span><br><span class="line"><span class="comment">## 流量分割（国内网段不走路由）</span></span><br><span class="line">只配置 route = xx 说明哪些地址走VPN，其余不走VPN。例如：只有国外地址才走VPN（route=），其余都不走VPN。</span><br><span class="line">只配置 no-route = xx 说明哪些地址不走VPN，其余全走VPN。例如：只有国内不走VPN（no-reoute=），其余都走VPN。</span><br><span class="line"></span><br><span class="line"><span class="comment">## 最小化的国内路由段</span></span><br><span class="line"><span class="comment">## ocserv下发的路由表最多支持下发**200**条路由表。为了尽可能的在200条路由表内塞下route或者no-route，大家发挥聪明才智通过合并cidr或者扩大cn的路由表范围等方式，有了很多优秀的no-route表，例如：https://github.com/CNMan/ocserv-cn-no-route</span></span><br></pre></td></tr></table></figure>



<h2 id="🍎-x3D-x3D-x3D-x3D-透明代理-x3D-x3D-x3D-x3D"><a href="#🍎-x3D-x3D-x3D-x3D-透明代理-x3D-x3D-x3D-x3D" class="headerlink" title="🍎&#x3D;&#x3D;&#x3D;&#x3D;透明代理&#x3D;&#x3D;&#x3D;&#x3D;"></a>🍎&#x3D;&#x3D;&#x3D;&#x3D;透明代理&#x3D;&#x3D;&#x3D;&#x3D;</h2><h2 id="Clash-透明代理技术-本机安装"><a href="#Clash-透明代理技术-本机安装" class="headerlink" title="Clash 透明代理技术 - 本机安装"></a>Clash 透明代理技术 - 本机安装</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 目的：OpenConnect 的流量分割配置，由于国家IP网段数量庞大，会在个人电脑插入大量的静态路由，性能不好说，很不科技。</span></span><br><span class="line"><span class="comment">## 另外，购买的收费服务，实现了很好的分割，我模仿它一直没做到，最后发现它使用的不是 默认的流量分割技术，所以开始进一步探索。</span></span><br><span class="line"><span class="comment">## 花了很长时间，最后定位到：透明代理技术 fake-ip: 伪造IP模式。clash的fake-ip技术 / v2ray的fake DNS技术</span></span><br><span class="line"><span class="comment">## - https://vlike.work/tech/trans_proxy.html</span></span><br><span class="line"><span class="comment">## - https://bulianglin.com/archives/dnsproxy.html</span></span><br><span class="line"><span class="comment">## - https://blog.lv5.moe/p/use-dns-to-create-split-routing-for-different-domain-or-ip-ranges</span></span><br><span class="line"><span class="comment">## - https://gist.github.com/cld4h/9a03ec2f826a25be5ab974fdbc540de4</span></span><br><span class="line"><span class="comment">## - https://www.sobyte.net/post/2022-02/clash-tproxy/</span></span><br><span class="line"><span class="comment">## - https://xtls.github.io/document/level-2/tproxy.html</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 首先你需要部署好 Clash</span></span><br><span class="line">- https://dreamacro.github.io/clash/</span><br><span class="line">wget https://github.com/Dreamacro/clash/releases/download/v1.17.0/clash-linux-amd64-v1.17.0.gz </span><br><span class="line">gunzip clash-linux-amd64-v1.17.0.gz &amp;&amp; <span class="built_in">chmod</span> +x clash-linux-amd64-v1.17.0</span><br><span class="line"></span><br><span class="line"><span class="comment">## Clash as a Service</span></span><br><span class="line"><span class="built_in">mv</span> clash-linux-amd64-v1.17.0 /usr/local/bin</span><br><span class="line"><span class="built_in">mkdir</span> /etc/clash</span><br><span class="line"><span class="built_in">touch</span> /etc/clash/config.yaml</span><br><span class="line"><span class="built_in">touch</span>  /etc/clash/Country.mmdb</span><br><span class="line"></span><br><span class="line">vi /etc/systemd/system/clash.service</span><br><span class="line">[Unit]</span><br><span class="line">Description=Clash daemon, A rule-based proxy <span class="keyword">in</span> Go.</span><br><span class="line">After=network-online.target</span><br><span class="line">[Service]</span><br><span class="line">User=clash</span><br><span class="line">Type=simple</span><br><span class="line">Restart=always</span><br><span class="line">ExecStart=/usr/local/bin/clash -d /etc/clash</span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line"></span><br><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl <span class="built_in">enable</span> clash</span><br><span class="line">systemctl start clash</span><br><span class="line">systemctl status clash</span><br><span class="line">journalctl -xe | grep clash</span><br><span class="line"></span><br><span class="line"><span class="comment">## 配置模板：https://raw.githubusercontent.com/XinSSS/Conf-for-Surge-Shadowrocket/master/clash_base.yaml</span></span><br><span class="line">clash -f /etc/clash/config.yaml</span><br><span class="line"><span class="comment"># TProxy 的透明代理端口</span></span><br><span class="line">tproxy-port: 7893</span><br><span class="line"><span class="comment"># mixed-port 端口将同时支持 SOCKS5/HTTP</span></span><br><span class="line">mixed-port: 7890</span><br><span class="line"><span class="comment"># 允许来自局域网的连接</span></span><br><span class="line">allow-lan: <span class="literal">true</span></span><br><span class="line"><span class="comment"># 绑定到所有接口</span></span><br><span class="line">bind-address: <span class="string">&#x27;127.0.0.1&#x27;</span></span><br><span class="line"><span class="comment">## 使用 fake-ip 模式的 Clash 既作为透明代理又作为 DNS Server</span></span><br><span class="line">dns:</span><br><span class="line">  <span class="built_in">enable</span>: <span class="literal">true</span></span><br><span class="line">  // 开启 fake-ip 模式</span><br><span class="line">  enhanced-mode: fake-ip</span><br><span class="line">  // 选择保留 ip 段，一般保持默认即可</span><br><span class="line">  fake-ip-range: 198.18.0.1/16</span><br><span class="line">  // 指定 Clash DNS 监听地址</span><br><span class="line">  listen: 0.0.0.0:53</span><br><span class="line">  // 指定上游公共 DNS</span><br><span class="line">  nameserver:</span><br><span class="line">  - 223.5.5.5:53</span><br><span class="line">  // 添加需要直连的国内域名</span><br><span class="line">  fake-ip-filter:</span><br><span class="line">  - baidu.com</span><br><span class="line">  - ...</span><br></pre></td></tr></table></figure>



<h2 id="Clash-透明代理技术-Tun-模式"><a href="#Clash-透明代理技术-Tun-模式" class="headerlink" title="Clash 透明代理技术 - Tun 模式"></a>Clash 透明代理技术 - Tun 模式</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cat /etc/clash/config.yaml</span></span><br><span class="line"><span class="attr">dns:</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">enhanced-mode:</span> <span class="string">fake-ip</span></span><br><span class="line">  <span class="attr">fake-ip-range:</span> <span class="number">198.16</span><span class="number">.0</span><span class="number">.1</span><span class="string">/16</span></span><br><span class="line">  <span class="attr">listen:</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span><span class="string">:1053</span></span><br><span class="line">  <span class="attr">nameserver:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="number">8.8</span><span class="number">.8</span><span class="number">.8</span><span class="string">:53</span></span><br><span class="line">  <span class="attr">fake-ip-filter:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">baidu.com</span></span><br><span class="line"><span class="attr">tun:</span>  <span class="string">//</span> <span class="string">需要</span> <span class="string">root</span> <span class="string">权限</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">stack:</span> <span class="string">system</span></span><br><span class="line">  <span class="string">//</span> <span class="string">自动为</span> <span class="string">fake-ip-range</span> <span class="string">中的</span> <span class="string">ip</span> <span class="string">段添加路由</span></span><br><span class="line">  <span class="attr">auto-route:</span> <span class="literal">true</span>  <span class="comment"># 使用 OpenConnect ocserv 时，开启这个配置，就会路由失败，不写这行运行正常。（原因未知）</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 转发从局域网收到的所有 DNS 查询流量到 1053 端口</span></span><br><span class="line"><span class="string">iptables</span> <span class="string">-t</span> <span class="string">nat</span> <span class="string">-I</span> <span class="string">PREROUTING</span> <span class="string">-p</span> <span class="string">udp</span> <span class="string">--dport</span> <span class="number">53</span> <span class="string">-j</span> <span class="string">REDIRECT</span> <span class="string">--to</span> <span class="number">1053</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 只劫持指定地址的 DNS 流量，只劫持vpnuser的dns 10.10.10.1，不劫持admin的dns 8.8.8.8</span></span><br><span class="line"><span class="comment"># admin 全流量完全代理，vpnuser流量分流代理</span></span><br><span class="line"><span class="string">iptables</span> <span class="string">-t</span> <span class="string">nat</span> <span class="string">-I</span> <span class="string">PREROUTING</span> <span class="string">-p</span> <span class="string">udp</span> <span class="string">--dport</span> <span class="number">53</span> <span class="string">-d</span> <span class="number">10.10</span><span class="number">.10</span><span class="number">.1</span><span class="string">/32</span> <span class="string">-j</span> <span class="string">REDIRECT</span> <span class="string">--to</span> <span class="number">1053</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="Clash-透明代理技术-DNS-分流"><a href="#Clash-透明代理技术-DNS-分流" class="headerlink" title="Clash 透明代理技术 - DNS 分流"></a>Clash 透明代理技术 - DNS 分流</h2><p>最关键的是需要将常见国内域名加入到 fake-ip-filter 中，这里推荐一个每日更新国内域名的项目：<a target="_blank" rel="noopener" href="https://github.com/felixonmars/dnsmasq-china-list">felixonmars&#x2F;dnsmasq-china-list</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 极简配置: 使用 fake-ip 模式的 Clash 既作为透明代理又作为 DNS Server，这种方式配置非常简单，只需要一个能运行 Clash 的设备即可</span></span><br><span class="line">dns:</span><br><span class="line">  <span class="built_in">enable</span>: <span class="literal">true</span></span><br><span class="line">  // 开启 fake-ip 模式</span><br><span class="line">  enhanced-mode: fake-ip</span><br><span class="line">  // 选择保留 ip 段，一般保持默认即可</span><br><span class="line">  fake-ip-range: 198.18.0.1/16</span><br><span class="line">  // 指定 Clash DNS 监听地址</span><br><span class="line">  listen: 0.0.0.0:53</span><br><span class="line">  // 指定上游公共 DNS</span><br><span class="line">  nameserver:</span><br><span class="line">  - 223.5.5.5:53</span><br><span class="line">  // 添加需要直连的国内域名</span><br><span class="line">  fake-ip-filter:</span><br><span class="line">  - baidu.com</span><br><span class="line">  - ...</span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取国内域名的脚本，自动生成 fake-ip-filter 清单。</span></span><br><span class="line"><span class="built_in">rm</span> -f accelerated-domains.china.conf</span><br><span class="line">wget https://raw.githubusercontent.com/felixonmars/dnsmasq-china-list/master/accelerated-domains.china.conf -O ./accelerated-domains.china.conf <span class="comment"># 中国的域名清单 https://github.com/felixonmars/dnsmasq-china-list</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;</span></span><br><span class="line"><span class="string">#LAN</span></span><br><span class="line"><span class="string">*.lan</span></span><br><span class="line"><span class="string">*.localdomain</span></span><br><span class="line"><span class="string">*.example</span></span><br><span class="line"><span class="string">*.invalid</span></span><br><span class="line"><span class="string">*.localhost</span></span><br><span class="line"><span class="string">*.test</span></span><br><span class="line"><span class="string">*.local</span></span><br><span class="line"><span class="string">*.home.arpa</span></span><br><span class="line"><span class="string">#放行NTP服务</span></span><br><span class="line"><span class="string">time.*.com</span></span><br><span class="line"><span class="string">time.*.gov</span></span><br><span class="line"><span class="string">time.*.edu.cn</span></span><br><span class="line"><span class="string">time.*.apple.com</span></span><br><span class="line"><span class="string">ntp.*.com</span></span><br><span class="line"><span class="string">*.time.edu.cn</span></span><br><span class="line"><span class="string">*.ntp.org.cn</span></span><br><span class="line"><span class="string">+.pool.ntp.org</span></span><br><span class="line"><span class="string">time1.cloud.tencent.com</span></span><br><span class="line"><span class="string">*.cn</span></span><br><span class="line"><span class="string">&#x27;</span> &gt; ./openclash_custom_fake_filter.list</span><br><span class="line">awk -F / <span class="string">&#x27;&#123;print &quot;+.&quot;$2&#125;&#x27;</span> ./accelerated-domains.china.conf &gt;&gt; ./openclash_custom_fake_filter.list</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;  fake-ip-filter:&#x27;</span> &gt; ./openclash_fake_filter.list</span><br><span class="line">awk <span class="string">&#x27;&#123;print &quot;    - &#x27;</span>\&#x27;<span class="string">&#x27;&quot;$1&quot;&#x27;</span>\&#x27;<span class="string">&#x27;&quot;&#125;&#x27;</span> ./openclash_custom_fake_filter.list &gt;&gt; ./openclash_fake_filter.list</span><br></pre></td></tr></table></figure>



<h2 id="DNS-精准分流-高级配置"><a href="#DNS-精准分流-高级配置" class="headerlink" title="DNS 精准分流 - 高级配置"></a>DNS 精准分流 - 高级配置</h2><ul>
<li><a target="_blank" rel="noopener" href="https://blog.lv5.moe/p/use-dns-to-create-split-routing-for-different-domain-or-ip-ranges">https://blog.lv5.moe/p/use-dns-to-create-split-routing-for-different-domain-or-ip-ranges</a></li>
</ul>
<p>使用 Clash DNS 的方案虽然配置非常简单，但是毕竟不可能将所有国内域名都统计出来，还需要根据 ip 进行更精准的分流</p>
<p><a target="_blank" rel="noopener" href="https://github.com/IrineSistiana/mosdns-cn">IrineSistiana&#x2F;mosdns-cn</a> 作为分流 DNS，这里引用 mosdns-cn 官方文档上介绍的分流规则</p>
<p>自己前面套个 mosdns v4 （v5砍掉了geosite&#x2F;geoip资源文件支持, 用起来更麻烦点）</p>
<p>TODO: 有待进一步研究</p>
<h2 id="Anyconnect-客户端"><a href="#Anyconnect-客户端" class="headerlink" title="Anyconnect  客户端"></a>Anyconnect  客户端</h2><p>客户端下载：anyconnect<br><a target="_blank" rel="noopener" href="https://devops-100tal.oss-cn-beijing.aliyuncs.com/vpnuserguide/vpnuserguide.htm">https://devops-100tal.oss-cn-beijing.aliyuncs.com/vpnuserguide/vpnuserguide.htm</a></p>
<h2 id="Anyconnect-命令行使用"><a href="#Anyconnect-命令行使用" class="headerlink" title="Anyconnect  命令行使用"></a>Anyconnect  命令行使用</h2><p>**使用脚本自动登录VPN **</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用脚本自动登录VPN &gt; To connect VPN via CMD</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 一句话执行：c2v.bat</span></span><br><span class="line">REM 第一步：关闭 AnyConnect 图形界面</span><br><span class="line">taskkill /F /IM vpnui.exe /T</span><br><span class="line"></span><br><span class="line">REM 第二步：关闭已有的 AnyConnect 连接</span><br><span class="line"><span class="string">&quot;C:\Program Files (x86)\Cisco\Cisco AnyConnect Secure Mobility Client&quot;</span>\vpncli.exe disconnect</span><br><span class="line"></span><br><span class="line">REM 第三步：读取配置文件自动连接</span><br><span class="line"><span class="string">&quot;C:\Program Files (x86)\Cisco\Cisco AnyConnect Secure Mobility Client&quot;</span>\vpncli.exe <span class="literal">-s</span> &lt; %USERPROFILE%\Videos\CWork\Topic\vpnfile.txt</span><br><span class="line"></span><br><span class="line"><span class="comment">## 配置文件格式</span></span><br><span class="line">.\vpncli.exe <span class="literal">-s</span> &lt; response.txt</span><br><span class="line">&gt; Template File</span><br><span class="line">&gt; connect &lt;host&gt;                    <span class="comment"># 例如：connect connect2vinoth.com</span></span><br><span class="line">&gt; [<span class="type">Optional</span>: <span class="type">drop</span> <span class="type">down</span> <span class="type">selection</span>]   <span class="comment"># 这里选择验证方式，选第一种方式输入：0，没有的话删除本行</span></span><br><span class="line">&gt; &lt;username&gt;                        <span class="comment"># 例如：myuser</span></span><br><span class="line">&gt; &lt;password&gt;                        <span class="comment"># 例如：mypass</span></span><br></pre></td></tr></table></figure>



<p><strong>To connect VPN via CMD</strong></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> <span class="string">&quot;C:\Program Files (x86)\Cisco\Cisco AnyConnect Secure Mobility Client&quot;</span></span><br><span class="line">.\vpncli.exe <span class="literal">-h</span></span><br><span class="line">    Usage: vpncli.exe [<span class="type">options</span>] | [<span class="type">cmd</span>] [<span class="type">host</span>]</span><br><span class="line">       commands: [<span class="type">connect</span>|<span class="type">disconnect</span>|<span class="type">hosts</span>|<span class="type">state</span>|<span class="type">stats</span>]</span><br><span class="line">       options:</span><br><span class="line">            <span class="literal">-h</span>         Print this usage statement.</span><br><span class="line">            <span class="literal">-v</span>         Print version.</span><br><span class="line">            <span class="literal">-s</span>         Read commands from response file to work non<span class="literal">-interactively</span>.</span><br><span class="line">                       Example: vpncli.exe <span class="literal">-s</span> &lt; response.txt</span><br><span class="line">.\vpncli.exe disconnect  <span class="comment"># 断开连接</span></span><br><span class="line"></span><br><span class="line">.\vpncli.exe connect xytth.com:<span class="number">1443</span>  <span class="comment"># 如果打开了图形界面会报错 error: Connect not available. Another AnyConnect application is running</span></span><br><span class="line"></span><br><span class="line"> .\vpncli.exe state   <span class="comment"># 查看连接状态</span></span><br><span class="line">  &gt;&gt; state: Connected</span><br><span class="line">  &gt;&gt; state: Connected</span><br><span class="line">  &gt;&gt; state: Connected</span><br><span class="line">  &gt;&gt; registered with local VPN subsystem.</span><br><span class="line"></span><br><span class="line">.\vpncli.exe stats   <span class="comment"># 查看连接详情</span></span><br><span class="line"></span><br><span class="line">REF: </span><br><span class="line"></span><br><span class="line">- [<span class="type">Connecting</span> <span class="type">to</span> <span class="type">AnyConnect</span> <span class="type">via</span> <span class="type">Command</span> <span class="type">Line</span> <span class="type">on</span> <span class="type">Windows</span>](https://it.umn.edu/services<span class="literal">-technologies</span>/how<span class="literal">-tos</span>/virtual<span class="literal">-private-network-vpn-advanced-0</span>)</span><br><span class="line">- [<span class="type">Connecting</span> <span class="type">CiscoAnyConnectVPN</span> <span class="type">via</span> <span class="type">bash</span> <span class="type">script</span> <span class="type">in</span> <span class="type">Windows</span>](https://medium.com/@vinothkumarsubbu/connecting<span class="literal">-ciscoanyconnectvpn-via-bash-script-in-windows-f749e706d115</span>)</span><br></pre></td></tr></table></figure>




<h2 id="🍎-x3D-x3D-x3D-x3D-网络调试-x3D-x3D-x3D-x3D"><a href="#🍎-x3D-x3D-x3D-x3D-网络调试-x3D-x3D-x3D-x3D" class="headerlink" title="🍎&#x3D;&#x3D;&#x3D;&#x3D;网络调试&#x3D;&#x3D;&#x3D;&#x3D;"></a>🍎&#x3D;&#x3D;&#x3D;&#x3D;网络调试&#x3D;&#x3D;&#x3D;&#x3D;</h2><h2 id="Network-Tools"><a href="#Network-Tools" class="headerlink" title="Network Tools"></a>Network Tools</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># https://www.redhat.com/sysadmin/beginners-guide-network-troubleshooting-linux</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Layer 1: The physical layer</span></span><br><span class="line">ip <span class="built_in">link</span> show</span><br><span class="line">ip <span class="built_in">link</span> <span class="built_in">set</span> eth0 up</span><br><span class="line">ip -br <span class="built_in">link</span> show</span><br><span class="line">ip -s <span class="built_in">link</span> show eth0</span><br><span class="line">ethtool eth0</span><br><span class="line"></span><br><span class="line"><span class="comment"># Layer 2: The data link layer</span></span><br><span class="line">ip neighbor show</span><br><span class="line"></span><br><span class="line"><span class="comment"># Layer 3: The network/internet layer</span></span><br><span class="line">ip -br address show</span><br><span class="line">ping www.google.com</span><br><span class="line">traceroute www.google.com</span><br><span class="line">ip route show</span><br><span class="line">nslookup www.google.com</span><br><span class="line"></span><br><span class="line"><span class="comment"># Layer 4: The transport layer</span></span><br><span class="line">telnet database.example.com 3306</span><br><span class="line">nc 192.168.122.1 -u 80</span><br><span class="line">ss -tunlp4</span><br><span class="line">Let’s <span class="built_in">break</span> down these flags:</span><br><span class="line">-t - Show TCP ports.</span><br><span class="line">-u - Show UDP ports.</span><br><span class="line">-n - Do not try to resolve hostnames.</span><br><span class="line">-l - Show only listening ports.</span><br><span class="line">-p - Show the processes that are using a particular socket.</span><br><span class="line">-4 - Show only IPv4 sockets.</span><br></pre></td></tr></table></figure>



<h2 id="Tcpdump-基本使用"><a href="#Tcpdump-基本使用" class="headerlink" title="Tcpdump 基本使用"></a>Tcpdump 基本使用</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 抓取所有的包 tcpdump</span></span><br><span class="line">tcpdump -i eth0  <span class="comment"># 监听特定的网卡</span></span><br><span class="line">tcpdump host hostname      <span class="comment"># 源和目的为该ip的都监听</span></span><br><span class="line">tcpdump src host hostname  <span class="comment"># 来源是指定主机</span></span><br><span class="line">tcpdump dst host hostname  <span class="comment"># 目标是指定主机</span></span><br><span class="line">tcpdump port 80            <span class="comment"># 监听特定的端口</span></span><br><span class="line">tcpdump src port 443       <span class="comment"># 来源是指定端口</span></span><br><span class="line">tcpdump dst port 443       <span class="comment"># 目标是指定端口</span></span><br><span class="line">tcpdump src portrange 4000-5000    <span class="comment"># 设置监听的端口范围</span></span><br><span class="line">tcpdump src net 192.168.50.0/24    <span class="comment"># 指定网段抓包</span></span><br><span class="line">tcpdump ip|ip6|tcp|udp|icmp        <span class="comment"># 抓取指定协议的数据包</span></span><br><span class="line"></span><br><span class="line">tcpdump ip host 210.27.48.1 and ! 210.27.48.2</span><br><span class="line">tcpdump tcp port 23 and host 210.27.48.1</span><br><span class="line"></span><br><span class="line"><span class="comment"># Flags [ ]：Flags代表了这个数据包的用途</span></span><br><span class="line">[S]	    SYN同步标识</span><br><span class="line">[.]	    .表示ACK确认标识</span><br><span class="line">[S.]	SYN同步标识，以及确认[S]的ACK</span><br><span class="line">[P.]	PSH，push推送，数据传输</span><br><span class="line">[R.]	RST，连接重置</span><br><span class="line">[F.]	FIN结束连接</span><br></pre></td></tr></table></figure>

<h2 id="Route-基础操作"><a href="#Route-基础操作" class="headerlink" title="Route 基础操作"></a>Route 基础操作</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">ip route add 198.16.0.0/16 via 172.17.63.253</span><br><span class="line"></span><br><span class="line">ip route add network <span class="built_in">command</span> examples</span><br><span class="line">The syntax is pretty simple:</span><br><span class="line">ip route add &#123;NETWORK/MASK&#125; via &#123;GATEWAYIP&#125;</span><br><span class="line">ip route add &#123;NETWORK/MASK&#125; dev &#123;DEVICE&#125;</span><br><span class="line">ip route add default &#123;NETWORK/MASK&#125; dev &#123;DEVICE&#125;</span><br><span class="line">ip route add default &#123;NETWORK/MASK&#125; via &#123;GATEWAYIP&#125;</span><br><span class="line"></span><br><span class="line">Add a static route on Linux</span><br><span class="line">You must login as root user with the <span class="built_in">help</span> of su <span class="built_in">command</span> or <span class="built_in">sudo</span> <span class="built_in">command</span>:</span><br><span class="line">$ su -</span><br><span class="line">OR use the <span class="built_in">sudo</span> as follows:</span><br><span class="line">$ <span class="built_in">sudo</span> -i</span><br><span class="line">Once become a root user, setup a temporary route using the ip <span class="built_in">command</span>:</span><br><span class="line"><span class="comment"># ip route add 172.10.1.0/24 via 10.0.0.100 dev eth0</span></span><br><span class="line">Verify new routing table, enter:</span><br><span class="line"><span class="comment"># ip r</span></span><br><span class="line">Here is another example <span class="built_in">where</span> I am setting up route <span class="keyword">for</span> my VPN gateway:</span><br><span class="line"><span class="comment"># ip link set dev tun0 up mtu 1500</span></span><br><span class="line"><span class="comment"># ip addr add dev tun0 10.8.0.2/24 broadcast 10.8.0.255</span></span><br><span class="line"><span class="comment"># ip route add 139.59.2.125/32 via 192.168.2.254</span></span><br><span class="line"><span class="comment"># ip route add 0.0.0.0/1 via 10.8.0.1</span></span><br><span class="line"><span class="comment"># ip route add 128.0.0.0/1 via 10.8.0.1</span></span><br><span class="line">Again view route with the ip <span class="built_in">command</span>:</span><br><span class="line"><span class="comment"># ip r</span></span><br></pre></td></tr></table></figure>



<h2 id="Iptables-示意图"><a href="#Iptables-示意图" class="headerlink" title="Iptables 示意图"></a>Iptables 示意图</h2><figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">┌─────────┐                                                                                      ┌─────────┐</span><br><span class="line">│         │             PREROUTING                                                INPUT          │         │</span><br><span class="line">│         │                                                                                      │         │</span><br><span class="line">│         │  ┌─────────────────────────────────────┐                      ┌────────────────────┐ │         │</span><br><span class="line">│         │  │                                     │         /───\        │                    │ │         │</span><br><span class="line">│         │  │ ┌───┐  ┌─────────┐  ┌──────┐  ┌───┐ │        /     \       │ ┌──────┐  ┌──────┐ │ │         │</span><br><span class="line">│         ├──┤►│raw├─►│conntrack├─►│mangle├─►│nat├─┼──────►&lt;routing&gt;──────┤►│mangle├─►│filter├─┤►│         │</span><br><span class="line">│         │  │ └───┘  └─────────┘  └──────┘  └───┘ │        \     /       │ └──────┘  └──────┘ │ │         │</span><br><span class="line">│         │  │                                     │         \─┬─/        │                    │ │         │</span><br><span class="line">│         │  └─────────────────────────────────────┘           │          └────────────────────┘ │         │</span><br><span class="line">│         │                                                    │                                 │         │</span><br><span class="line">│         │                               ┌──────────┐         │                                 │         │</span><br><span class="line">│         │                               │          │         │                                 │         │</span><br><span class="line">│         │                               │ ┌──────┐ │         │                                 │         │</span><br><span class="line">│         │                               │ │mangle◄─┼─────────┘                                 │         │</span><br><span class="line">│ Network │                               │ └──┬───┘ │                                           │  Local  │</span><br><span class="line">│Interface│                               │    │     │ FORWARD                                   │ Process │</span><br><span class="line">│         │                               │ ┌──▼───┐ │                                  /───\    │         │</span><br><span class="line">│         │               ┌───────────────┼─┤filter│ │                                 /     \   │         │</span><br><span class="line">│         │               │               │ └──────┘ │                                &lt;routing&gt;◄─┤         │</span><br><span class="line">│         │               │               │          │                                 \     /   │         │</span><br><span class="line">│         │               │               └──────────┘                                  \─┬─/    │         │</span><br><span class="line">│         │               │                                                               │      │         │</span><br><span class="line">│         │  ┌────────────┼────┐               ┌──────────────────────────────────────────┼────┐ │         │</span><br><span class="line">│         │  │            │    │     ─────     │                                          │    │ │         │</span><br><span class="line">│         │  │ ┌───┐  ┌───▼──┐ │    /     \    │ ┌──────┐  ┌───┐  ┌──────┐  ┌─────────┐  ┌▼──┐ │ │         │</span><br><span class="line">│         │◄─┼─┤nat│◄─┤mangle│◄├───&lt;reroute&gt;───┼─┤filter│◄─┤nat│◄─┤mangle│◄─┤conntrack│◄─┤raw│ │ │         │</span><br><span class="line">│         │  │ └───┘  └──────┘ │    \check/    │ └──────┘  └───┘  └──────┘  └─────────┘  └───┘ │ │         │</span><br><span class="line">│         │  │                 │     ─────     │                                               │ │         │</span><br><span class="line">│         │  └─────────────────┘               └───────────────────────────────────────────────┘ │         │</span><br><span class="line">│         │     POSTROUTING                                        OUTPUT                        │         │</span><br><span class="line">│         │                                                                                      │         │</span><br><span class="line">└─────────┘                                                                                      └─────────┘</span><br></pre></td></tr></table></figure>

<h2 id="Iptables-Debug"><a href="#Iptables-Debug" class="headerlink" title="Iptables Debug"></a>Iptables Debug</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># https://www.fosslinux.com/100268/iptables-and-logging-how-to-monitor-network-traffic.htm</span></span><br><span class="line"><span class="comment"># 打开 iptables 日志</span></span><br><span class="line"><span class="built_in">sudo</span> iptables -A INPUT -j LOG --log-prefix <span class="string">&quot;iptables_input: &quot;</span> --log-level 4</span><br><span class="line"><span class="built_in">sudo</span> iptables -A OUTPUT -j LOG --log-prefix <span class="string">&quot;iptables_output: &quot;</span> --log-level 4</span><br><span class="line"><span class="built_in">sudo</span> iptables -A FORWARD -j LOG --log-prefix <span class="string">&quot;iptables_forward: &quot;</span> --log-level 4</span><br><span class="line"></span><br><span class="line"><span class="comment"># 关闭 iptables 日志</span></span><br><span class="line"><span class="built_in">sudo</span> iptables -D INPUT -j LOG --log-prefix <span class="string">&quot;iptables_input: &quot;</span> --log-level 4</span><br><span class="line"><span class="built_in">sudo</span> iptables -D OUTPUT -j LOG --log-prefix <span class="string">&quot;iptables_output: &quot;</span> --log-level 4</span><br><span class="line"><span class="built_in">sudo</span> iptables -D FORWARD -j LOG --log-prefix <span class="string">&quot;iptables_forward: &quot;</span> --log-level 4</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看 iptables 日志</span></span><br><span class="line">journalctl -xe -f | grep iptables</span><br></pre></td></tr></table></figure>



<h2 id="Iptables-tproxy-透明代理技术原理"><a href="#Iptables-tproxy-透明代理技术原理" class="headerlink" title="Iptables tproxy 透明代理技术原理"></a>Iptables tproxy 透明代理技术原理</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># https://www.bilibili.com/read/cv14088928/</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 从本机出去的数据包会经过 OUTPUT 链 和 POSTROUTING 链。</span></span><br><span class="line"><span class="comment"># 从外部发往本机的数据包会经过 PREROUTING 链 和 INPUT 链。</span></span><br><span class="line"><span class="comment"># Linux 内核提供的 tproxy（Transparent proxy）透明代理能力，tproxy 只能工作在 PREROUTING 链。</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 参数功能：</span></span><br><span class="line"><span class="comment"># -t/--table [table]：表示这条规则作用在哪个表上</span></span><br><span class="line"><span class="comment"># -A/--append [chain]：表示给这个链添加一条规则</span></span><br><span class="line"><span class="comment"># -p/--protocol [protocol]：表示处理哪个协议</span></span><br><span class="line"><span class="comment"># -j/--jump [target]：表示跳转到哪个目标</span></span><br><span class="line"><span class="comment"># -d/--destination [address] 表示匹配对应的 ip（范围） </span></span><br><span class="line"><span class="comment"># -N/--new-chain [chain] 表示创建一个新的链</span></span><br><span class="line"><span class="comment"># -D/--delete：从一个链上删除指定的规则</span></span><br><span class="line"><span class="comment"># -F/--flush [chain]：清空一个链上所有规则</span></span><br><span class="line"><span class="comment"># -X/--delete-chain [chain]：删除一个链</span></span><br><span class="line"><span class="comment"># -I/--insert [chain] [rule index] 表示插入一条规则到指定位置，默认为 1，表示插入到规则的第一条。</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 在 OUTPUT 链中，目标 IP 为外网时，应当经过 tproxy。 由于 tproxy 只能工作在 PREROUTING 链，从本机发出去的数据包会直接通过 OUTPUT 链出去了，本机数据包没有机会走 PREROUTING 链。为了让本机数据经过 PREROUTING，我们可以用的路由表解决。</span></span><br><span class="line">ip rule add fwmark 666 table 999                <span class="comment"># 表示被标记为 666 的数据包的走向要查表 999</span></span><br><span class="line">ip route add <span class="built_in">local</span> 0.0.0.0/0 dev lo table 999   <span class="comment"># 大致是说对于 999 表的流量，都要发到本机的 PREROUTING </span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 当我们给 OUTPUT 链的数据包进行标记时，这个数据包会重新查一次表，如果我们标记的刚好是 666，那这个数据包就会根据上面的规则进入本机的 PREROUTING。这样一来，我们就可以将本机的数据包发送的 tproxy。 </span></span><br><span class="line"><span class="comment"># iptables 中有三个常用的表，filter、nat 和 mangle，三个表有各自的用途，能链的作用范围也不一样，mangle 表支持在 OUTPUT 链上打标记。</span></span><br><span class="line"><span class="comment"># 在 OUTPUT 链上的 tcp/udp 协议都跳转到 MARK 并标记个 666。 此时被标记为 666 的数据包会重新走到 PROROUTING 链上。 </span></span><br><span class="line"><span class="comment"># tproxy 仅能处理 tcp 和 udp，所以这里只标记这两个协议。 </span></span><br><span class="line"><span class="comment"># 在 OUTPUT 链上打标记命令如下：</span></span><br><span class="line">iptables -t mangle -A OUTPUT -p tcp -j MARK --set-mark 666</span><br><span class="line">iptables -t mangle -A OUTPUT -p udp -j MARK --set-mark 666</span><br><span class="line"></span><br><span class="line"><span class="comment"># 上面的规则虽然完成了重回 PREROUTING 的能力，但有些数据包应当直接从 OUTPUT 链出去，比如访问网关管理页面（192.168.22.1），或者是 NAS 的 192.168.22.2。所以我们需要跳过一部分的数据包避免标记上 666。</span></span><br><span class="line"><span class="comment"># 在 OUTPUT 链上，如果是发往 192.168.0.0/16 的数据包，则直接返回。这一条命令要在前面的 -j MARK 命令之前执行，匹配规则会根据创建的规则顺序按顺序执行。 </span></span><br><span class="line">iptables -t mangle -A OUTPUT -d 192.168.0.0/16 -j RETURN</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 表示去往 非 192.168.0.0/16 的 tcp/udp 数据包标记 666</span></span><br><span class="line">iptables -t mangle -A OUTPUT -d 192.168.0.0/16 -j RETURN</span><br><span class="line">iptables -t mangle -A OUTPUT -p tcp -j MARK --set-mark 666</span><br><span class="line">iptables -t mangle -A OUTPUT -p udp -j MARK --set-mark 666</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建了一个自定义链 LOCAL_DIVERT</span></span><br><span class="line">iptables -t mangle -N LOCAL_DIVERT</span><br><span class="line">iptables -t mangle -A LOCAL_DIVERT -d 192.168.0.0/16 -j RETURN</span><br><span class="line">iptables -t mangle -A LOCAL_DIVERT -p tcp -j MARK --set-mark 666</span><br><span class="line">iptables -t mangle -A LOCAL_DIVERT -p udp -j MARK --set-mark 666</span><br><span class="line"><span class="comment"># 接下来需要跳转到这个链</span></span><br><span class="line">iptables -t mangle -A OUTPUT -j LOCAL_DIVERT</span><br><span class="line"></span><br><span class="line"><span class="comment"># 当不需要 LOCAL_DIVERT 时，我们可以通过以下命令删除（要小心翼翼）</span></span><br><span class="line">iptables -t mangle -D OUTPUT -j LOCAL_DIVERT  <span class="comment"># 首先删除跳转（调用）的引用</span></span><br><span class="line">iptables -t mangle -F LOCAL_DIVERT            <span class="comment"># 然后删除 LOCAL_DIVERT 中的全部规则</span></span><br><span class="line">iptables -t mangle -X LOCAL_DIVERT            <span class="comment"># 然后删除 LOCAL_DIVERT 这个链</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 可以将数据包通过 tproxy 发给 clash</span></span><br><span class="line">iptables -t mangle -A PREROUTING -p tcp -j TPROXY --on-port 7893</span><br><span class="line">iptables -t mangle -A PREROUTING -p udp -j TPROXY --on-port 7893</span><br><span class="line"></span><br><span class="line"><span class="comment"># 当前完整的 iptables 命令如下：</span></span><br><span class="line">iptables -t mangle -N DIVERT</span><br><span class="line">iptables -t mangle -A DIVERT -d 192.168.0.0/16 -j RETURN       <span class="comment"># 本地网络直接放行，从外到内的流量不走 tproxy</span></span><br><span class="line">iptables -t mangle -A DIVERT -p tcp -j TPROXY --on-port 7893</span><br><span class="line">iptables -t mangle -A DIVERT -p udp -j TPROXY --on-port 7893</span><br><span class="line">iptables -t mangle -A PREROUTING -j DIVERT</span><br><span class="line"></span><br><span class="line">iptables -t mangle -N LOCAL_DIVERT</span><br><span class="line">iptables -t mangle -A LOCAL_DIVERT -d 192.168.0.0/16 -j RETURN  <span class="comment"># 本地网络直接放行，从内到外的流量不走 tproxy</span></span><br><span class="line">iptables -t mangle -A LOCAL_DIVERT -p tcp -j MARK --set-mark 666</span><br><span class="line">iptables -t mangle -A LOCAL_DIVERT -p udp -j MARK --set-mark 666</span><br><span class="line">iptables -t mangle -A OUTPUT -j LOCAL_DIVERT</span><br><span class="line"></span><br><span class="line"><span class="comment"># 上面产生了一个回环，我们需要解决掉，即让本机 clash 发出来的数据包直接从 OUTPUT 链出去</span></span><br><span class="line"><span class="comment"># 通过 gid/uid 绕过回环。 </span></span><br><span class="line"></span><br><span class="line">grep -qw clash /etc/passwd || <span class="built_in">echo</span> <span class="string">&quot;clash:x:0:23333:::&quot;</span> &gt;&gt; /etc/passwd  <span class="comment"># 创建一个名为 clash，uid 为 0，gid 为 23333 的用户</span></span><br><span class="line"><span class="built_in">sudo</span> -u clash <span class="built_in">id</span>   <span class="comment"># 可以验证创建的用户是否正常：</span></span><br><span class="line"><span class="built_in">sudo</span> -u clash /usr/local/bin/clash -d /etc/clash  <span class="comment"># 接下来我们使用这个用户启动 clash</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># iptables 执行在 OUTPUT 链改为如下命令：</span></span><br><span class="line"><span class="comment"># -m/-match 表示匹配对应的策略，上面的命令则是在 OUTPUT 链 gid 非 23333 的数据包跳转到 LOCAL_DIVERT。</span></span><br><span class="line">iptables -t mangle -A OUTPUT -m owner ! --gid-owner 23333 -j LOCAL_DIVERT</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用 clash 的 tproxy 能力时，需要让 clash 接管 DNS 流量</span></span><br><span class="line"><span class="comment"># 1.停掉本地的 DNS 服务，将 clash 的 DNS 服务端口改为 53 2.将 DNS 查询数据包转发到 clash</span></span><br><span class="line">iptables -t nat -N LOCAL_DNS_DIVERT</span><br><span class="line">iptables -t nat -A LOCAL_DNS_DIVERT -p udp --dport 53 -j REDIRECT --to-ports 1053  <span class="comment"># 1053 是在 clash 上设置的 DNS 服务端口</span></span><br><span class="line">iptables -t nat -I OUTPUT -m owner ! --gid-owner 23333 -j LOCAL_DNS_DIVERT</span><br><span class="line"></span><br><span class="line"><span class="comment"># 绕过更多内网 IP 段。发往 127.0.0.1:1053 的 DNS 查询数据包会通过 OUTPUT 链回到 PREROUTING 最后进入到 tproxy。 我们可以在 OUTPUT 链跳过去</span></span><br><span class="line">iptables -t mangle -A LOCAL_DIVERT -d 127.0.0.0/8 -j RETURN</span><br><span class="line">iptables -t mangle -A DIVERT -d 127.0.0.0/8 -j RETURN <span class="comment"># 回来数据包仍然经过 PREROUTING，同样需要跳过</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 我们还有更多的内网/特殊 IP 段需要直接 RETURN，完整列表如下：</span></span><br><span class="line">100.64.0.0/10</span><br><span class="line">127.0.0.0/8</span><br><span class="line">169.254.0.0/16</span><br><span class="line">192.0.0.0/24</span><br><span class="line">224.0.0.0/4</span><br><span class="line">240.0.0.0/4</span><br><span class="line">255.255.255.255/32</span><br><span class="line">192.168.0.0/16</span><br><span class="line">172.16.0.0/12</span><br><span class="line">10.0.0.0/8</span><br></pre></td></tr></table></figure>

<p><strong>完整配置记录</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># https://gist.github.com/DianQK/25cf82bff5136068b98575adef598f82#file-iptables_1-sh</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Clash 配置</span></span><br><span class="line">grep -qw clash /etc/passwd || <span class="built_in">echo</span> <span class="string">&quot;clash:x:0:23333:::&quot;</span> &gt;&gt; /etc/passwd  <span class="comment"># 创建一个名为 clash，uid 为 0，gid 为 23333 的用户</span></span><br><span class="line"><span class="built_in">sudo</span> -u clash <span class="built_in">id</span>   <span class="comment"># 可以验证创建的用户是否正常：</span></span><br><span class="line"><span class="built_in">sudo</span> -u clash /usr/local/bin/clash -d /etc/clash  <span class="comment"># 接下来我们使用这个用户启动 clash</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">cat</span> &lt;&lt; <span class="string">EOF &gt; config.yaml</span></span><br><span class="line"><span class="string">tproxy-port: 7893</span></span><br><span class="line"><span class="string">dns:</span></span><br><span class="line"><span class="string">  enable: true</span></span><br><span class="line"><span class="string">  enhanced-mode: fake-ip</span></span><br><span class="line"><span class="string">  fake-ip-range: 198.16.0.1/16</span></span><br><span class="line"><span class="string">  listen: 0.0.0.0:1053</span></span><br><span class="line"><span class="string">  nameserver:</span></span><br><span class="line"><span class="string">    - 8.8.8.8:53</span></span><br><span class="line"><span class="string">  fake-ip-filter:</span></span><br><span class="line"><span class="string">    - 163.com</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 跳过来自服务端口的流量</span></span><br><span class="line"><span class="comment"># https web server</span></span><br><span class="line">iptables -t mangle -I OUTPUT -p tcp --sport 80 -j RETURN</span><br><span class="line">iptables -t mangle -I OUTPUT -p tcp --sport 443 -j RETURN</span><br><span class="line">iptables -t mangle -I OUTPUT -p tcp --sport 22 -j RETURN</span><br><span class="line">iptables -t mangle -I OUTPUT -p tcp --sport 1443 -j RETURN</span><br><span class="line">iptables -t mangle -I OUTPUT -p udp --sport 1443 -j RETURN</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建入站规则</span></span><br><span class="line">iptables -t mangle -N DIVERT</span><br><span class="line">iptables -t mangle -A DIVERT -d 8.219.56.209/32 -j RETURN</span><br><span class="line">iptables -t mangle -A DIVERT -d 100.64.0.0/10 -j RETURN</span><br><span class="line">iptables -t mangle -A DIVERT -d 127.0.0.0/8 -j RETURN</span><br><span class="line">iptables -t mangle -A DIVERT -d 169.254.0.0/16 -j RETURN</span><br><span class="line">iptables -t mangle -A DIVERT -d 192.0.0.0/24 -j RETURN</span><br><span class="line">iptables -t mangle -A DIVERT -d 224.0.0.0/4 -j RETURN</span><br><span class="line">iptables -t mangle -A DIVERT -d 240.0.0.0/4 -j RETURN</span><br><span class="line">iptables -t mangle -A DIVERT -d 255.255.255.255/32 -j RETURN</span><br><span class="line">iptables -t mangle -A DIVERT -d 192.168.0.0/16 -j RETURN</span><br><span class="line">iptables -t mangle -A DIVERT -d 172.16.0.0/12 -j RETURN</span><br><span class="line">iptables -t mangle -A DIVERT -d 10.0.0.0/8 -j RETURN</span><br><span class="line">iptables -t mangle -A DIVERT -p tcp -j TPROXY --on-port 7893</span><br><span class="line">iptables -t mangle -A DIVERT -p udp -j TPROXY --on-port 7893</span><br><span class="line">iptables -t mangle -A PREROUTING -j DIVERT</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建出站规则</span></span><br><span class="line">ip rule add fwmark 666 table 999</span><br><span class="line">ip route add <span class="built_in">local</span> 0.0.0.0/0 dev lo table 999</span><br><span class="line">iptables -t mangle -N LOCAL_DIVERT</span><br><span class="line">iptables -t mangle -A LOCAL_DIVERT -d 8.219.56.209/32 -j RETURN</span><br><span class="line">iptables -t mangle -A LOCAL_DIVERT -d 100.64.0.0/10 -j RETURN</span><br><span class="line">iptables -t mangle -A LOCAL_DIVERT -d 127.0.0.0/8 -j RETURN</span><br><span class="line">iptables -t mangle -A LOCAL_DIVERT -d 169.254.0.0/16 -j RETURN</span><br><span class="line">iptables -t mangle -A LOCAL_DIVERT -d 192.0.0.0/24 -j RETURN</span><br><span class="line">iptables -t mangle -A LOCAL_DIVERT -d 224.0.0.0/4 -j RETURN</span><br><span class="line">iptables -t mangle -A LOCAL_DIVERT -d 240.0.0.0/4 -j RETURN</span><br><span class="line">iptables -t mangle -A LOCAL_DIVERT -d 255.255.255.255/32 -j RETURN</span><br><span class="line">iptables -t mangle -A LOCAL_DIVERT -d 192.168.0.0/16 -j RETURN</span><br><span class="line">iptables -t mangle -A LOCAL_DIVERT -d 172.16.0.0/12 -j RETURN</span><br><span class="line">iptables -t mangle -A LOCAL_DIVERT -d 10.0.0.0/8 -j RETURN</span><br><span class="line">iptables -t mangle -A LOCAL_DIVERT -p tcp -j MARK --set-mark 666</span><br><span class="line">iptables -t mangle -A LOCAL_DIVERT -p udp -j MARK --set-mark 666</span><br><span class="line">iptables -t mangle -A OUTPUT -m owner ! --gid-owner 23333 -j LOCAL_DIVERT</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建 DNS 规则</span></span><br><span class="line">iptables -t nat -N LOCAL_DNS_DIVERT</span><br><span class="line">iptables -t nat -A LOCAL_DNS_DIVERT -p udp --dport 53 -j REDIRECT --to-ports 1053  <span class="comment"># 1053 是在 clash 上设置的 DNS 服务端口</span></span><br><span class="line">iptables -t nat -I OUTPUT -m owner ! --gid-owner 23333 -j LOCAL_DNS_DIVERT</span><br><span class="line"></span><br><span class="line"><span class="comment"># 关闭 出站 规则</span></span><br><span class="line">iptables -t mangle -D OUTPUT -m owner ! --gid-owner 23333 -j LOCAL_DIVERT</span><br><span class="line">iptables -t mangle -F LOCAL_DIVERT</span><br><span class="line">iptables -t mangle -X LOCAL_DIVERT</span><br><span class="line"><span class="comment"># 关闭清空 入站 规则</span></span><br><span class="line">iptables -t mangle -D PREROUTING -j DIVERT</span><br><span class="line">iptables -t mangle -F DIVERT</span><br><span class="line">iptables -t mangle -X DIVERT</span><br><span class="line"><span class="comment"># 关闭清空 DNS 规则</span></span><br><span class="line">iptables -t nat -D OUTPUT -m owner ! --gid-owner 23333 -j LOCAL_DNS_DIVERT</span><br><span class="line">iptables -t nat -F LOCAL_DNS_DIVERT</span><br><span class="line">iptables -t nat -X LOCAL_DNS_DIVERT</span><br><span class="line"></span><br><span class="line"><span class="comment"># 补充：转发从局域网收到的所有 DNS 查询流量到 1053 端口</span></span><br><span class="line">iptables -t nat -I PREROUTING -p udp --dport 53 -j REDIRECT --to 1053</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除</span></span><br><span class="line">iptables -t nat -D PREROUTING -p udp --dport 53 -j REDIRECT --to 1053</span><br></pre></td></tr></table></figure>

<h3 id="端口复用"><a href="#端口复用" class="headerlink" title="端口复用"></a>端口复用</h3><ul>
<li><a target="_blank" rel="noopener" href="https://www.freebuf.com/articles/web/261429.html">https://www.freebuf.com/articles/web/261429.html</a></li>
<li><a target="_blank" rel="noopener" href="https://saucer-man.com/operation_and_maintenance/586.html">https://saucer-man.com/operation_and_maintenance/586.html</a></li>
<li><a target="_blank" rel="noopener" href="https://idiotc4t.com/defense-evasion/shadowmove-emersion-and-think">https://idiotc4t.com/defense-evasion/shadowmove-emersion-and-think</a></li>
<li><a target="_blank" rel="noopener" href="https://www.usenix.org/system/files/sec20summer_niakanlahiji_prepub.pdf">https://www.usenix.org/system/files/sec20summer_niakanlahiji_prepub.pdf</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.vackbot.com/archives/%E4%BB%A3%E7%90%86%E7%AB%AF%E5%8F%A3%E5%A4%8D%E7%94%A8%E5%9C%A8%E5%90%8E%E6%B8%97%E9%80%8F%E5%9C%BA%E6%99%AF%E4%B8%AD%E7%9A%84%E5%BA%94%E7%94%A8%E6%8E%A2%E7%A9%B6">https://blog.vackbot.com/archives/%E4%BB%A3%E7%90%86%E7%AB%AF%E5%8F%A3%E5%A4%8D%E7%94%A8%E5%9C%A8%E5%90%8E%E6%B8%97%E9%80%8F%E5%9C%BA%E6%99%AF%E4%B8%AD%E7%9A%84%E5%BA%94%E7%94%A8%E6%8E%A2%E7%A9%B6</a></li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">在后渗透场景中，代理几乎是不可或缺的一部分，对于多层网络架构的复杂内网环境而言，多级代理、多协议代理、端口复用等代理功能便尤为重要，本文将分以下几个部分逐步介绍：</span><br><span class="line"></span><br><span class="line">常见代理的方式</span><br><span class="line">代理端口复用研究</span><br><span class="line">基于已有服务的端口复用方式</span><br><span class="line">常见代理方式</span><br><span class="line">反向代理</span><br><span class="line">反向代理（Reverse Proxy）指的是由目标服务器主动像客户端发起连接请求的代理模式，这种代理模式通常是攻防实战中完成边界突破后的代理方式的优选项，稳定性相对更佳。缺点是服务器需要具备出网能力，在流量侧会有主动外连的痕迹，如果使用的代理工具存在流量侧特征容易被态势感知等设备发现。列举几个反代工具：</span><br><span class="line">1、frp</span><br><span class="line">https://github.com/fatedier/frp.git</span><br><span class="line"></span><br><span class="line">2、earthworm</span><br><span class="line">https://github.com/idlefire/ew.git</span><br><span class="line"></span><br><span class="line">3、ngrok</span><br><span class="line">https://github.com/inconshreveable/ngrok.git</span><br><span class="line"></span><br><span class="line">4、nps</span><br><span class="line">https://github.com/ehang-io/nps</span><br><span class="line"></span><br><span class="line">5、erfrp</span><br><span class="line">https://github.com/Goqi/Erfrp</span><br><span class="line"></span><br><span class="line">正向代理</span><br><span class="line">正向代理（Forward Proxy）是指由客户端向代理服务器发起请求，并由代理服务器向目标转发的代理方式，这种代理模式是科学上网常用的代理方式。在攻防实战中，由于目标主机服务器通常在内网环境，服务由例如nginx等服务将服务端口代理映射出去，因此在服务上主动创建的代理监听服务很难通过公网访问到。通常做法是复用web服务，通过对应的开发语言写代理的服务，再通过正向代理实现连接，这种方式通常稳定性和速度相对较差，通常在服务器无法出网的情况下选择。列举两个webProxy：</span><br><span class="line"></span><br><span class="line">1、reGeorg</span><br><span class="line">https://github.com/sensepost/reGeorg.git</span><br><span class="line"></span><br><span class="line">2、Neo-reGeorg</span><br><span class="line">https://github.com/L-codes/Neo-reGeorg</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">端口复用</span><br><span class="line">端口复用，也被称为端口共享，是指在同一台主机上，允许多个网络应用程序使用同一个网络端口的技术。这种技术可以有效地提高网络资源的利用率，避免端口资源的浪费。在网络安全场景下的端口复用主要目的是为了隐藏攻击痕迹和进行防火墙bypass。</span><br><span class="line"></span><br><span class="line">重定向方式实现</span><br><span class="line">使用场景通常为防火墙限制了访问端口。通过系统的流量转发功能实现，Linux下通过iptables实现流量转发。假设原本服务器开放了80端口，我们要将eth0网卡的80端口流量全部转发到本地代理监听端口8080。</span><br><span class="line"></span><br><span class="line">iptables -t nat -A PREROUTING -i eth0 -p tcp --dport 80 -j REDIRECT --to-port 8080</span><br><span class="line">再由监听的代理服务做流量分流处理，将带有代理特征的流量保留下来，目标流量发送回对应服务，保证原本服务正常进行。比如如果我们劫持转发的服务为web服务，而我们的代理协议使用的是socks5协议，我们可以通过协议头进行判断和过滤。</span><br><span class="line"></span><br><span class="line">对于windows而言，非系统服务，比如重定向 Windows 上的 Apache 的 8080 端口到 1080 端口，我们可以使用 IpNat 进行转发。</span><br><span class="line"></span><br><span class="line"># 转发命令 </span><br><span class="line">netsh interface portproxy add v4tov4 listenport=源端口 listenaddress=源IP connectport=目标端口 connectaddress=目标IP</span><br><span class="line"></span><br><span class="line"># 查看转发规则</span><br><span class="line">netsh interface portproxy show all</span><br><span class="line"></span><br><span class="line"># 删除规则</span><br><span class="line">netsh interface portproxy delete v4tov4 listenport=源端口 listenaddress=源IP</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<div class="article-footer reveal fs14"><section id="license"><div class="header"><span>许可协议</span></div><div class="body"><p>本文采用 <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">署名-非商业性使用-相同方式共享 4.0 国际</a> 许可协议，转载请注明出处。</p>
</div></section></div>

</article>

<div class="related-wrap reveal" id="read-next"><section class="body"><div class="item" id="prev"><div class="note">较新文章</div><a href="/2024/01/01/basetools/Atlassian-Confluence/">Atlassian-Confluence与JIRA安装配置全攻略</a></div><div class="item" id="next"><div class="note">较早文章</div><a href="/2024/01/01/basetools/OneKeyInstall/">编程环境一键安装指南 | Windows与Linux全平台覆盖</a></div></section></div>








      
<footer class="page-footer reveal fs12"><hr><div class="text"><p>本站由 <a href="/">@anonymity</a> 使用 <a target="_blank" rel="noopener" href="https://github.com/xaoxuu/hexo-theme-stellar">Stellar</a> 主题创建。<br>本博客所有文章除特别声明外，均采用 <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> 许可协议，转载请注明出处。</p>
</div></footer>

      <div class='float-panel mobile-only blur' style='display:none'>
  <button type='button' class='sidebar-toggle mobile' onclick='sidebar.toggle()'>
    <svg class="icon" style="width: 1em; height: 1em;vertical-align: middle;fill: currentColor;overflow: hidden;" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="15301"><path d="M566.407 808.3c26.9-0.1 49.3-20.8 51.6-47.6-1.9-27.7-23.9-49.7-51.6-51.6h-412.6c-28.2-1.4-52.6 19.5-55.5 47.6 2.3 26.8 24.6 47.5 51.6 47.6h416.5v4z m309.3-249.9c26.9-0.1 49.3-20.8 51.6-47.6-2.2-26.8-24.6-47.5-51.6-47.6h-721.9c-27.7-2.8-52.5 17.4-55.3 45.1-0.1 0.8-0.1 1.7-0.2 2.5 0.9 27.2 23.6 48.5 50.7 47.6H875.707z m-103.1-245.9c26.9-0.1 49.3-20.8 51.6-47.6-0.4-28.3-23.2-51.1-51.5-51.6h-618.9c-29.5-1.1-54.3 21.9-55.5 51.4v0.2c1.4 27.8 25.2 49.2 53 47.8 0.8 0 1.7-0.1 2.5-0.2h618.8z" p-id="15302"></path><path d="M566.407 808.3c26.9-0.1 49.3-20.8 51.6-47.6-1.9-27.7-23.9-49.7-51.6-51.6h-412.6c-28.2-1.4-52.6 19.5-55.5 47.6 1.9 27.7 23.9 49.7 51.6 51.6h416.5z m309.3-249.9c26.9-0.1 49.3-20.8 51.6-47.6-2.2-26.8-24.6-47.5-51.6-47.6h-721.9c-27.7-2.8-52.5 17.4-55.3 45.1-0.1 0.8-0.1 1.7-0.2 2.5 0.9 27.2 23.6 48.5 50.7 47.6H875.707z m-103.1-245.9c26.9-0.1 49.3-20.8 51.6-47.6-0.4-28.3-23.2-51.1-51.5-51.6h-618.9c-29.5-1.1-54.3 21.9-55.5 51.4v0.2c1.4 27.8 25.2 49.2 53 47.8 0.8 0 1.7-0.1 2.5-0.2h618.8z" p-id="15303"></path></svg>
  </button>
</div>

    </div>
  </div>
  <div class='scripts'>
    <script type="text/javascript">
  const stellar = {
    // 懒加载 css https://github.com/filamentgroup/loadCSS
    loadCSS: (href, before, media, attributes) => {
      var doc = window.document;
      var ss = doc.createElement("link");
      var ref;
      if (before) {
        ref = before;
      } else {
        var refs = (doc.body || doc.getElementsByTagName("head")[0]).childNodes;
        ref = refs[refs.length - 1];
      }
      var sheets = doc.styleSheets;
      if (attributes) {
        for (var attributeName in attributes) {
          if (attributes.hasOwnProperty(attributeName)) {
            ss.setAttribute(attributeName, attributes[attributeName]);
          }
        }
      }
      ss.rel = "stylesheet";
      ss.href = href;
      ss.media = "only x";
      function ready(cb) {
        if (doc.body) {
          return cb();
        }
        setTimeout(function () {
          ready(cb);
        });
      }
      ready(function () {
        ref.parentNode.insertBefore(ss, before ? ref : ref.nextSibling);
      });
      var onloadcssdefined = function (cb) {
        var resolvedHref = ss.href;
        var i = sheets.length;
        while (i--) {
          if (sheets[i].href === resolvedHref) {
            return cb();
          }
        }
        setTimeout(function () {
          onloadcssdefined(cb);
        });
      };
      function loadCB() {
        if (ss.addEventListener) {
          ss.removeEventListener("load", loadCB);
        }
        ss.media = media || "all";
      }
      if (ss.addEventListener) {
        ss.addEventListener("load", loadCB);
      }
      ss.onloadcssdefined = onloadcssdefined;
      onloadcssdefined(loadCB);
      return ss;
    },

    // 从 butterfly 和 volantis 获得灵感
    loadScript: (src, opt) => new Promise((resolve, reject) => {
      var script = document.createElement('script');
      if (src.startsWith('/')){
        src = stellar.config.root + src.substring(1);
      }
      script.src = src;
      if (opt) {
        for (let key of Object.keys(opt)) {
          script[key] = opt[key]
        }
      } else {
        // 默认异步，如果需要同步，第二个参数传入 {} 即可
        script.async = true
      }
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    }),

    // https://github.com/jerryc127/hexo-theme-butterfly
    jQuery: (fn) => {
      if (typeof jQuery === 'undefined') {
        stellar.loadScript(stellar.plugins.jQuery).then(fn)
      } else {
        fn()
      }
    }
  };
  stellar.version = '1.19.0';
  stellar.github = 'https://github.com/xaoxuu/hexo-theme-stellar/tree/1.19.0';
  stellar.config = {
    date_suffix: {
      just: '刚刚',
      min: '分钟前',
      hour: '小时前',
      day: '天前',
      month: '个月前',
    },
    root : '/',
  };

  // required plugins (only load if needs)
  stellar.plugins = {
    jQuery: 'https://gcore.jsdelivr.net/npm/jquery@3.6.2/dist/jquery.min.js'
  };

  if ('local_search') {
    stellar.search = {};
    stellar.search.service = 'local_search';
    if (stellar.search.service == 'local_search') {
      let service_obj = Object.assign({}, {"field":"all","path":"/search.json","content":true,"codeblock":true,"sort":"-date"});
      stellar.search[stellar.search.service] = service_obj;
    }
  }

  // stellar js
  stellar.plugins.stellar = Object.assign({"sites":"/js/plugins/sites.js","friends":"/js/plugins/friends.js","ghinfo":"/js/plugins/ghinfo.js","timeline":"/js/plugins/timeline.js","linkcard":"/js/plugins/linkcard.js","fcircle":"/js/plugins/fcircle.js","weibo":"/js/plugins/weibo.js"});

  stellar.plugins.marked = Object.assign("https://cdn.bootcdn.net/ajax/libs/marked/4.0.18/marked.min.js");
  // optional plugins
  if ('true' == 'true') {
    stellar.plugins.lazyload = Object.assign({"enable":true,"js":"https://gcore.jsdelivr.net/npm/vanilla-lazyload@17.8.3/dist/lazyload.min.js","transition":"blur"});
  }
  if ('true' == 'true') {
    stellar.plugins.swiper = Object.assign({"enable":true,"css":"https://unpkg.com/swiper@8.4.5/swiper-bundle.min.css","js":"https://unpkg.com/swiper@8.4.5/swiper-bundle.min.js"});
  }
  if ('' == 'true') {
    stellar.plugins.scrollreveal = Object.assign({"enable":null,"js":"https://gcore.jsdelivr.net/npm/scrollreveal@4.0.9/dist/scrollreveal.min.js","distance":"8px","duration":500,"interval":100,"scale":1});
  }
  if ('true' == 'true') {
    stellar.plugins.preload = Object.assign({"enable":true,"service":"flying_pages","instant_page":"https://gcore.jsdelivr.net/gh/volantis-x/cdn-volantis@4.1.2/js/instant_page.js","flying_pages":"https://gcore.jsdelivr.net/gh/gijo-varghese/flying-pages@2.1.2/flying-pages.min.js"});
  }
  if ('true' == 'true') {
    stellar.plugins.fancybox = Object.assign({"enable":true,"js":"https://gcore.jsdelivr.net/npm/@fancyapps/ui@4.0/dist/fancybox.umd.js","css":"https://gcore.jsdelivr.net/npm/@fancyapps/ui@4.0/dist/fancybox.css","selector":".swiper-slide img"});
  }
  if ('false' == 'true') {
    stellar.plugins.heti = Object.assign({"enable":false,"css":"https://unpkg.com/heti@0.9.2/umd/heti.min.css","js":"https://unpkg.com/heti@0.9.2/umd/heti-addon.min.js"});
  }
  if ('true' == 'true') {
    stellar.plugins.copycode = Object.assign({"enable":true,"js":"/js/plugins/copycode.js","default_text":"Copy","success_text":"Copied"});
  }
</script>

<!-- required -->

  
<script src="/js/main.js" async></script>



<!-- optional -->



<!-- inject -->


  </div>
</body>
</html>
